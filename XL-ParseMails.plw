#!/usr/bin/perl
# Perl - v: 5.16.3
#------------------------------------------------------------------------------#
# XL-ParseMails.plw     : Part of the XL-Toolkit, XL-Parsemails provides functions
#                         to parse email for analysis.
# Website               : http://le-tools.com/XL-ParseMails.html
# SourceForge           : https://sourceforge.net/p/xl-parsemails
# GitHub                : https://github.com/arioux/XL-ParseMails
# Creation              : 2020-06-01
# Modified              : 2021-04-10
my $VERSION             = '2.0.1';
# Author                : Alain Rioux (admin@le-tools.com)
#
# Copyright (C) 2021 Alain Rioux (le-tools.com)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#------------------------------------------------------------------------------#
# Modules
#------------------------------------------------------------------------------#
use strict;
use utf8;
use DBI;
use base qw/Net::DNS::Resolver::Base/;
use Net::DNS;
use Net::CIDR 'cidrlookup';
use Encode qw(encode decode);
use MIME::Base64 qw( decode_base64 );
use MIME::QuotedPrint;
use Excel::Writer::XLSX;
use Extract::Regex;                  # This is a personal module
use File::Spec::Functions qw(canonpath);
use File::Path qw(make_path);
use DateTime;
use DateTime::TimeZone;
use HTTP::Date qw(str2time);
use GeoIP2::Database::Reader;
use LWP::UserAgent;
use Net::IP;
use Regexp::IPv6 qw($IPv6_re);
use Win32::API();
use Win32::GUI();
use Win32::GUI 1.06 qw(:toolbar ILC_MASK CW_USEDEFAULT);
use Win32::Process;
use threads;
use threads::shared;
use Email::Outlook::Message;
use Email::Simple;
require "XL-ParseMailsGraph.pl";

#------------------------------------------------------------------------------#
# Global variables
#------------------------------------------------------------------------------#
my $PROGDIR = $0;                                                              # Program path
while (chop($PROGDIR) ne "\\") { }                                             # Dir only
my $REF_ARG = \@ARGV;                                                          # If objects passed (using SendTo)
my %SETTINGS;                                                                  # Settings
my %GUI;                                                                       # GUI Controls
my %FIELDS;                                                                    # Selected fields
my $USERDIR;                                                                   # User path
if (-d "$ENV{'APPDATA'}\\XL-Toolkit\\XL-ParseMails") { $USERDIR = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-ParseMails"; }
else                                                 { $USERDIR = $PROGDIR;                                     }
my $SETTINGS_FILE  = "$USERDIR\\XL-ParseMails.ini";                            # Settings file
my $LOGGING_FILE   = "$USERDIR\\XL-ParseMails.log";                            # Logging file for errors
my $URL_DOC        = "http://le-tools.com/XL-ParseMails.html";                 # Online documentation
my $URL_TOOL       = 'http://le-tools.com/XL-ParseMails.html#Download';        # Url of the tool
my $URL_VER        = 'http://www.le-tools.com/download/XL-ParseMailsVer.txt';  # Url of the version file
my $ARROW          :shared;                                                    # Arrow pointer
my $HOURGLASS      :shared;                                                    # Hourglass pointer
my $FIELDS_WIN_CALLER;                                                         # Caller of the Fields window
my $THR_PROCESS;                                                               # Thread for process
my $THR_UPDATE;                                                                # Thread for update
$GUI{START} = 0;

#------------------------------------------------------------------------------#
# Graphic elements
#------------------------------------------------------------------------------#
my ($refIMG) = loadGraph();

#------------------------------------------------------------------------------#
# Main window
#------------------------------------------------------------------------------#
my $screen    = Win32::GUI::GetDesktopWindow(); # Screen resolution
my $scrnX     = Win32::GUI::Width($screen);
my $scrnY     = Win32::GUI::Height($screen);
my $winWidth  = 710;
my $winHeight = 480;
my $winPosX   = ($scrnX - $winWidth)  / 2;
my $winPosY   = ($scrnY - $winHeight) / 2;
# Main Window
my $win = Win32::GUI::Window->new(-name        => 'winMain'               ,
                                  -text        => 'XL-ParseMails'         ,
                                  -background  => [255, 255, 255]         ,
                                  -size        => [$winWidth, $winHeight] ,
                                  -pos         => [$winPosX , $winPosY]   ,
                                  -minheight   => $winHeight              ,
                                  -minwidth    => $winWidth               , );
$win->SetIcon($$refIMG{ico});
# Fonts
sub LOGPIXELSX() {88}
sub getDPI { return(Win32::GUI::DC->new()->GetDeviceCaps(LOGPIXELSX)); }
my $DPI = &getDPI();
my ($fontGB, $fontGB2, $font9, $font9b, $font9u, $font10, $font8);
# Larger size (125% and 150%)
if ($DPI >= 120) {
  $fontGB  = new Win32::GUI::Font(-name => 'Arial', -size => 10, -bold => 1);
  $fontGB2 = new Win32::GUI::Font(-name => 'Arial', -size => 12, -bold => 1, -underline => 1);
  $font9   = new Win32::GUI::Font(-name => 'Arial', -size =>  7);
  $font9b  = new Win32::GUI::Font(-name => 'Arial', -size =>  7, -bold => 1);
  $font9u  = new Win32::GUI::Font(-name => 'Arial', -size =>  7, -bold => 1, -underline => 1);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size =>  8);
  $font8   = new Win32::GUI::Font(-name => 'Arial', -size =>  6);
# Normal size
} else {
  $fontGB  = new Win32::GUI::Font(-name => 'Arial', -size => 12, -bold => 1);
  $fontGB2 = new Win32::GUI::Font(-name => 'Arial', -size => 14, -bold => 1, -underline => 1);
  $font9   = new Win32::GUI::Font(-name => 'Arial', -size =>  9);
  $font9b  = new Win32::GUI::Font(-name => 'Arial', -size =>  9, -bold => 1);
  $font9u  = new Win32::GUI::Font(-name => 'Arial', -size =>  9, -bold => 1, -underline => 1);
  $font10  = new Win32::GUI::Font(-name => 'Arial', -size => 10);
  $font8   = new Win32::GUI::Font(-name => 'Arial', -size =>  8);
}
# Load Pointers
my $loadImage = new Win32::API('user32', 'LoadImage', ['N','N','I','I','I','I'],'N');
$HOURGLASS    = $loadImage->Call(0, 32514, 2, 0, 0, 0x8040);
$ARROW        = $loadImage->Call(0, 32512, 2, 0, 0, 0x8040);
# Header
$win->AddLabel(       -name        => 'lblLogo'               ,
                      -size        => [320, 60]               ,
                      -pos         => [  0,  0]               ,
                      -bitmap      => $$refIMG{header}        , );
$win->AddLabel(       -name        => 'lblHeader'             ,
                      -size        => [400, 60]               ,
                      -pos         => [320,  0]               ,
                      -background  => [251, 251, 251]         , );
# Input section
$win->AddLabel(       -name        => 'lblInputT'             ,
                      -size        => [$winWidth, 24]         ,
                      -pos         => [  0, 60]               ,
                      -text        => ' Input directory'      ,
                      -font        => $fontGB                 ,
                      -foreground  => [255, 255, 255]         ,
                      -background  => [ 92, 172, 238]         , );
$win->AddTextfield(   -name        => 'tfInput'               ,
                      -size        => [500, 22]               ,
                      -pos         => [  5, 95]               , );
$win->AddButton(      -name        => 'btnInput'              ,
                      -size        => [ 22, 22]               ,
                      -pos         => [508, 95]               ,
                      -bitmap      => $$refIMG{open16}        , );
$win->AddCheckbox(    -name        => 'chInputDirRecurse'     ,
                      -size        => [120, 22]               ,
                      -pos         => [533, 96]               ,
                      -text        => 'Subfolders'            ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       , );
$win->AddLabel(       -name        => 'lblFormat'             ,
                      -size        => [ 80, 22]               ,
                      -pos         => [  5,128]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'Format:'               ,
                      -font        => $font9                  , );
$win->AddCheckbox(    -name        => 'chInputMSG'            ,
                      -size        => [ 60, 22]               ,
                      -pos         => [ 85,126]               ,
                      -text        => '*.msg'                 ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       , );
$win->AddCheckbox(    -name        => 'chInputEML'            ,
                      -size        => [ 60, 22]               ,
                      -pos         => [160,126]               ,
                      -text        => '*.eml'                 ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       , );
# Functions
$win->AddLabel(       -name        => 'lblFunctionsT'         ,
                      -size        => [$winWidth, 24]         ,
                      -pos         => [  0,156]               ,
                      -text        => ' Functions'            ,
                      -font        => $fontGB                 ,
                      -foreground  => [255, 255, 255]         ,
                      -background  => [ 92, 172, 238]         , );
$win->AddTabStrip(    -name        => 'TabFunctions'          ,
                      -size        => [$winWidth-4, 24]       ,
                      -pos         => [  0,180]               ,
                      -font        => $font10                 ,
                      -background  => [255, 255, 255]         , );
$win->TabFunctions->InsertItem(-text  => 'Parse Headers '     , );
$win->TabFunctions->InsertItem(-text  => 'Extract '           , );
$win->TabFunctions->InsertItem(-text  => 'Search '            , );
$win->TabFunctions->InsertItem(-text  => 'Gephi '             , );

# Parse headers tab

$win->AddLabel(       -name        => 'lblPHFields'           ,
                      -size        => [ 80, 22]               ,
                      -pos         => [  5,218]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'Fields:'               ,
                      -font        => $font9                  , );
$win->AddRadioButton( -name        => 'rbPHTypical'           ,
                      -size        => [ 80, 22]               ,
                      -pos         => [105,215]               ,
                      -text        => 'Typical'               ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -group       => 1                       ,
                      -checked     => 1                       , );
$win->AddRadioButton( -name        => 'rbPHAll'               ,
                      -size        => [ 60, 22]               ,
                      -pos         => [185,215]               ,
                      -text        => 'All'                   ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  , );
$win->AddRadioButton( -name        => 'rbPHChoose'            ,
                      -size        => [ 80, 22]               ,
                      -pos         => [245,215]               ,
                      -text        => 'Choose'                ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  , );
$win->AddButton(      -name        => 'btnPHSelect'           ,
                      -size        => [110, 24]               ,
                      -pos         => [325,214]               ,
                      -font        => $font9                  ,
                      -text        => 'Select fields...'      ,
                      -disabled    => 1                       , );
$win->AddCheckbox(    -name        => 'chPHAllReceived'       ,
                      -size        => [240, 22]               ,
                      -pos         => [105,243]               ,
                      -text        => 'All Received fields (default is last only)',
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  , );
$win->AddCheckbox(    -name        => 'chPHDatetime'          ,
                      -size        => [200, 22]               ,
                      -pos         => [360,243]               ,
                      -text        => 'Convert datetime (ISO)',
                      -background  => [255, 255, 255]         ,
                      -font        => $font10                 , );
$win->AddLabel(       -name        => 'lblPHAdd'              ,
                      -size        => [ 80, 22]               ,
                      -pos         => [  5,273]               ,
                      -background  => [255, 255, 255]         ,
                      -text        => 'Add:'                  ,
                      -font        => $font9                  , );
$win->AddCheckbox(    -name        => 'chPHSourceFile'        ,
                      -size        => [100, 22]               ,
                      -pos         => [105,270]               ,
                      -text        => 'Source file'           ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       , );
$win->AddCheckbox(    -name        => 'chPHAttachList'        ,
                      -size        => [155, 22]               ,
                      -pos         => [205,270]               ,
                      -text        => 'List of attached files',
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  , );
$win->AddCheckbox(    -name        => 'chPHNSLookup'          ,
                      -size        => [100, 22]               ,
                      -pos         => [360,270]               ,
                      -text        => 'NSLookup'              ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font10                 , );
$win->AddCheckbox(    -name        => 'chPHISP'               ,
                      -size        => [160, 22]               ,
                      -pos         => [460,270]               ,
                      -text        => 'ISP details (XL-Whois)',
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       , );
$win->AddCheckbox(    -name        => 'chPHGeoIP'             ,
                      -size        => [ 60, 22]               ,
                      -pos         => [620,270]               ,
                      -text        => 'GeoIP'                 ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       , );
$win->AddLabel(       -name        => 'lblReport'             ,
                      -size        => [ 80, 20]               ,
                      -pos         => [  5,303]               ,
                      -font        => $font9                  ,
                      -background  => [255, 255, 255]         , 
                      -text        => 'Report:'               , );
$win->AddCombobox(    -name        => 'cbReportFormat'        ,
                      -size        => [ 60, 22]               ,
                      -pos         => [105,300]               ,
                      -dropdownlist => 1                      ,
                      -vscroll     => 1                       , );
$win->cbReportFormat->Add('XLSX', 'HTML', 'CSV');
$win->cbReportFormat->SetCurSel(0);
$win->AddLabel(       -name        => 'lblXLXSMaxWidth'       ,
                      -size        => [120, 20]               ,
                      -pos         => [190,333]               ,
                      -font        => $font9                  ,
                      -background  => [255, 255, 255]         , 
                      -text        => 'Max column width:'     , );
$win->AddTextfield(   -name        => 'tfXLXSMaxWidth'        ,
                      -size        => [ 50, 22]               ,
                      -pos         => [310,330]               ,
                      -number      => 1                       , );
$win->AddUpDown(      -name        => 'upXLXSMaxWidth'        , );
$win->upXLXSMaxWidth->SetRange(10,255);
$win->AddLabel(       -name        => 'lblCSVSepar'           ,
                      -size        => [ 80, 20]               ,
                      -pos         => [190,333]               ,
                      -font        => $font9                  ,
                      -background  => [255, 255, 255]         , 
                      -text        => 'Separator:'            ,
                      -visible     => 0                       , );
$win->AddCombobox(    -name        => 'cbCSVSepar'            ,
                      -size        => [ 60, 22]               ,
                      -pos         => [270,330]               ,
                      -dropdownlist => 1                      ,
                      -vscroll     => 1                       ,
                      -visible     => 0                       , );
$win->cbCSVSepar->Add('Tab', ',', ';', '|');
# Destination Directory
$win->AddLabel(       -name        => 'lblDestDir'            ,
                      -size        => [ 80, 20]               ,
                      -pos         => [  5,303]               ,
                      -font        => $font9                  ,
                      -background  => [255, 255, 255]         , 
                      -text        => 'Directory:'            , );
$win->AddTextfield(   -name        => 'tfDestDir'             ,
										  -font        => $font9                  ,
                      -size        => [400, 22]               ,
                      -pos         => [105,300]               , );
$win->AddButton(      -name        => 'btnSelDestDir'         ,
                      -size        => [ 22, 22]               ,
                      -pos         => [549,300]               ,
                      -bitmap      => $$refIMG{open16}        ,
										  -tip         => 'Select a directory for report', );
$win->AddButton(      -name        => 'btnOpenSelDir'         ,
                      -size        => [ 22, 22]               ,
                      -pos         => [573,300]               ,
                      -bitmap      => $$refIMG{browse16}      ,
                      -tip         => 'Open the report folder in Windows Explorer', );
$win->AddCheckbox(    -name        => 'chOpenAtEnd'           ,
                      -size        => [180, 22]               ,
                      -pos         => [105,330]               ,
                      -text        => 'Open when finished'    ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       , );

# Extract tab

$win->AddCheckbox(    -name        => 'chEHeaders'            ,
                      -size        => [130, 22]               ,
                      -pos         => [  5,215]               ,
                      -text        => 'Headers'               ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbETypical'            ,
                      -size        => [ 80, 22]               ,
                      -pos         => [135,215]               ,
                      -text        => 'Typical'               ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -group       => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbEAll'                ,
                      -size        => [ 60, 22]               ,
                      -pos         => [215,215]               ,
                      -text        => 'All'                   ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbEChoose'             ,
                      -size        => [ 80, 22]               ,
                      -pos         => [315,215]               ,
                      -text        => 'Choose'                ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnESelect'            ,
                      -size        => [110, 24]               ,
                      -pos         => [425,214]               ,
                      -font        => $font9                  ,
                      -text        => 'Select fields...'      ,
                      -disabled    => 1                       , 
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chEBody'               ,
                      -size        => [130, 22]               ,
                      -pos         => [  5,245]               ,
                      -text        => 'Body'                  ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chEBodyText'           ,
                      -size        => [ 80, 22]               ,
                      -pos         => [135,245]               ,
                      -text        => 'Text'                  ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chEBodyHTML'           ,
                      -size        => [ 80, 22]               ,
                      -pos         => [215,245]               ,
                      -text        => 'HTML'                  ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chEBodyMerge'          ,
                      -size        => [200, 22]               ,
                      -pos         => [315,245]               ,
                      -text        => 'Merge Headers and Body',
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       , 
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chEAttach'             ,
                      -size        => [130, 22]               ,
                      -pos         => [  5,275]               ,
                      -text        => 'Attachements'          ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbEAttachAll'          ,
                      -size        => [ 80, 22]               ,
                      -pos         => [135,275]               ,
                      -text        => 'All'                   ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -group       => 1                       ,
                      -checked     => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbEAttachImg'          ,
                      -size        => [100, 22]               ,
                      -pos         => [215,275]               ,
                      -text        => 'Image only'            ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbEAttachExt'          ,
                      -size        => [110, 22]               ,
                      -pos         => [315,275]               ,
                      -text        => 'By extension:'         ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddTextfield(   -name        => 'tfEAttachExt'          ,
                      -size        => [150, 22]               ,
                      -pos         => [425,275]               ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chESource'             ,
                      -size        => [200, 22]               ,
                      -pos         => [105,305]               ,
                      -text        => 'Include source in filename',
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chEMsgFolder'          ,
                      -size        => [300, 22]               ,
                      -pos         => [320,305]               ,
                      -text        => 'Create a folder for each message',
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -visible     => 0                       , );

# Search tab

$win->AddRadioButton( -name        => 'rbSAll'                ,
                      -size        => [ 60, 22]               ,
                      -pos         => [  5,215]               ,
                      -text        => 'All'                   ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -group       => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbSHeader'             ,
                      -size        => [120, 22]               ,
                      -pos         => [ 65,215]               ,
                      -text        => 'In header only'        ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbSBody'               ,
                      -size        => [110, 22]               ,
                      -pos         => [185,215]               ,
                      -text        => 'In body only'          ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblSBodyLeft'          ,
                      -size        => [  5, 20]               ,
                      -pos         => [296,218]               ,
                      -font        => $font9                  ,
                      -background  => [255, 255, 255]         , 
                      -text        => '('                     ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chSBodyText'           ,
                      -size        => [ 60, 22]               ,
                      -pos         => [308,215]               ,
                      -text        => 'Text'                  ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chSBodyHTML'           ,
                      -size        => [ 60, 22]               ,
                      -pos         => [368,215]               ,
                      -text        => 'HTML )'                ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chSSource'             ,
                      -size        => [120, 22]               ,
                      -pos         => [  5,245]               ,
                      -text        => 'Add source file'       ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chSCase'               ,
                      -size        => [120, 22]               ,
                      -pos         => [105,275]               ,
                      -text        => 'Match case'            ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chSRegex'              ,
                      -size        => [300, 22]               ,
                      -pos         => [225,275]               ,
                      -text        => 'Regex'                 ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblSTerms'             ,
                      -size        => [100, 20]               ,
                      -pos         => [  5,303]               ,
                      -font        => $font9                  ,
                      -background  => [255, 255, 255]         , 
                      -text        => 'Search terms:'         ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblSTermsOk'           ,
                      -size        => [402, 24]               ,
                      -pos         => [104,299]               ,
                      -background  => [  0, 255,   0]         ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblSTermsErr'          ,
                      -size        => [402, 24]               ,
                      -pos         => [104,299]               ,
                      -background  => [255,   0,   0]         ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblSTermsWarn'         ,
                      -size        => [402, 24]               ,
                      -pos         => [104,299]               ,
                      -background  => [255, 255,   0]         ,
                      -visible     => 0                       , );
$win->AddTextfield(   -name        => 'tfSTerms'              ,
										  -font        => $font9                  ,
                      -size        => [400, 22]               ,
                      -pos         => [105,300]               ,
                      -visible     => 0                       , );

# Gephi

$win->AddCheckbox(    -name        => 'chGReceived'           ,
                      -size        => [100, 22]               ,
                      -pos         => [  5,215]               ,
                      -text        => 'Received'              ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbGRecvIP'             ,
                      -size        => [120, 22]               ,
                      -pos         => [105,215]               ,
                      -text        => 'IP addresses'          ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -group       => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbGRecvHost'           ,
                      -size        => [120, 22]               ,
                      -pos         => [225,215]               ,
                      -text        => 'Hostnames'             ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbGRecvBoth'           ,
                      -size        => [120, 22]               ,
                      -pos         => [345,215]               ,
                      -text        => 'Both'                  ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbGRecvFrom'           ,
                      -size        => [120, 22]               ,
                      -pos         => [105,240]               ,
                      -text        => 'From'                  ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -group       => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbGRecvBy'             ,
                      -size        => [120, 22]               ,
                      -pos         => [225,240]               ,
                      -text        => 'By'                    ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbGRecvFB'             ,
                      -size        => [120, 22]               ,
                      -pos         => [345,240]               ,
                      -text        => 'Both'                  ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddCheckbox(    -name        => 'chGEmails'             ,
                      -size        => [100, 22]               ,
                      -pos         => [  5,270]               ,
                      -text        => 'Emails'                ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbGEmailName'          ,
                      -size        => [120, 22]               ,
                      -pos         => [105,270]               ,
                      -text        => 'Names'                 ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -group       => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbGEmailAddr'          ,
                      -size        => [120, 22]               ,
                      -pos         => [225,270]               ,
                      -text        => 'Addresses'             ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );
$win->AddRadioButton( -name        => 'rbGEmailBoth'          ,
                      -size        => [120, 22]               ,
                      -pos         => [345,270]               ,
                      -text        => 'Both'                  ,
                      -background  => [255, 255, 255]         ,
                      -font        => $font9                  ,
                      -checked     => 1                       ,
                      -disabled    => 1                       ,
                      -visible     => 0                       , );

# Footer
$win->AddLabel(       -name        => 'lblFooter'             ,
                      -size        => [$winWidth, 80]         ,
                      -pos         => [  2,$winHeight-82]     ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [128, 128, 128]         , );
$win->AddLabel(       -name        => 'lblNotReady'           ,
                      -size        => [170, 22]               ,
                      -pos         => [ 10, $winHeight-65]    ,
                      -background  => [250, 250, 250]         ,
                      -foreground  => [  0, 102, 204]         ,
                      -text        => 'Not Ready? Click here' ,
                      -font        => $font9u                 ,
                      -notify      => 1                       , );
$win->AddLabel(       -name        => 'lblPbCurr'             ,
                      -size        => [495, 20]               ,
                      -pos         => [ 10, $winHeight-75]    ,
                      -font        => $font9                  ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -visible     => 0                       , );
$win->AddProgressBar( -name        => 'pb'                    ,
                      -size        => [410, 20]               ,
                      -pos         => [ 10, $winHeight-55]    ,
                      -smooth      => 1                       ,
                      -visible     => 0                       , );
$win->AddLabel(       -name        => 'lblPbCount'            ,
                      -size        => [130, 20]               ,
                      -pos         => [425, $winHeight-53]    ,
                      -font        => $font9                  ,
                      -truncate    => 1                       ,
                      -background  => [250, 250, 250]         ,
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnProcess'            ,
                      -size        => [ 40, 40]               ,
                      -pos         => [510,$winHeight-75]     ,
                      -bitmap      => $$refIMG{process32}     ,
                      -background  => [250, 250, 250]         ,
                      -tip         => 'Process'               ,
                      -disabled    => 1                       , );
$win->AddButton(      -name        => 'btnStop'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [510,$winHeight-75]     ,
                      -bitmap      => $$refIMG{stop32}        ,
                      -background  => [250, 250, 250]         ,
                      -tip         => 'Stop the running process',
                      -visible     => 0                       , );
$win->AddButton(      -name        => 'btnWinSettings'        ,
                      -size        => [ 40, 40]               ,
                      -pos         => [555,$winHeight-75]     ,
                      -bitmap      => $$refIMG{settings32}    ,
                      -background  => [250, 250, 250]         ,
                      -tip         => 'Open settings window...', );
$win->AddButton(      -name        => 'btnHelp'               ,
                      -size        => [ 40, 40]               ,
                      -pos         => [600,$winHeight-75]     ,
                      -bitmap      => $$refIMG{doc32}         ,
                      -background  => [250, 250, 250]         ,
                      -tip         => 'See documentation'     , );
$win->AddButton(      -name        => 'btnAbout'              ,
                      -size        => [ 40, 40]               ,
                      -pos         => [645,$winHeight-75]     ,
                      -bitmap      => $$refIMG{about32}       ,
                      -background  => [250, 250, 250]         ,
                      -tip         => 'About...'              , );
#------------------------------------------------------------------------------#
# Settings window
#------------------------------------------------------------------------------#
my $winSettings = Win32::GUI::DialogBox->new(
  -name        => 'winSettings'           ,
  -parent      => $win                    ,
  -text        => 'Settings'              ,
  -pos         => [$winPosX, $winPosY]    ,
  -size        => [600, 325]              ,
  -background  => [255, 255, 255]         ,
  -hasmaximize => 0                       ,
  -hasminimize => 0                       ,
  -helpbutton  => 0                       ,
  -resizable   => 0                       ,
  -dialogui    => 1                       , );
$winSettings->SetIcon($$refIMG{ico});
$winSettings->AddLabel(   -name         => 'lblLogo'             ,
                          -size         => [128,128]             ,
                          -pos          => [  0,  5]             ,
                          -bitmap       => $$refIMG{settings128} ,
                          -background   => [255, 255, 255]       , );
# Tabstrip
$winSettings->AddTabStrip(-name         => 'settingsTab'         ,
                          -size         => [455,290]             ,
                          -pos          => [140,  5]             ,
                          -fixedwidth   => 1                     ,
                          -background   => [255, 255, 255]       , );
$winSettings->settingsTab->InsertItem(-text => 'General');
$winSettings->settingsTab->InsertItem(-text => 'Databases');
# General tab
# Tool Section
$winSettings->AddLabel(     -name        => 'lblToolShadowT'        ,
                            -size        => [ 80, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => 'Tool:'                 ,
                            -font        => $fontGB2                , );
$winSettings->AddLabel(     -name        => 'lblToolT'              ,
                            -size        => [ 80, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [ 92, 172, 238]         ,
                            -text        => 'Tool:'                 ,
                            -font        => $fontGB2                , );
$winSettings->AddButton(    -name        => 'btnOpenUserDir'        ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 68]               ,
                            -text        => 'Open user dir...'      ,
                            -font        => $font9                  , );
$winSettings->AddButton(    -name        => 'btnCheckUpdate'        ,
                            -size        => [125, 24]               ,
                            -pos         => [280, 68]               ,
                            -text        => 'Check update'          ,
                            -font        => $font9                  , );
$winSettings->AddCheckbox(  -name        => 'chAutoUpdate'          ,
                            -size        => [180, 20]               ,
                            -pos         => [410, 69]               ,
                            -text        => 'Check update at startup',
                            -background  => [255, 255, 255]         ,
                            -font        => $font9                  ,
                            -checked     => 1                       , );
$winSettings->AddButton(    -name        => 'btnOpenLog'            ,
                            -size        => [125, 24]               ,
                            -pos         => [150, 98]               ,
                            -text        => 'Open log file'         ,
                            -font        => $font9                  , );
$winSettings->AddCheckbox(  -name        => 'chLogging'             ,
                            -size        => [120, 20]               ,
                            -pos         => [280, 99]               ,
                            -text        => 'Enable logging'        ,
                            -background  => [255, 255, 255]         ,
                            -font        => $font9                  ,
                            -checked     => 1                       , );
# Functions section
$winSettings->AddLabel(     -name        => 'lblFuncShadowT'        ,
                            -size        => [350, 22]               ,
                            -pos         => [151,136]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => 'Functions:'            ,
                            -font        => $fontGB2                , );
$winSettings->AddLabel(     -name        => 'lblFuncT'              ,
                            -size        => [350, 22]               ,
                            -pos         => [150,135]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [ 92, 172, 238]         ,
                            -text        => 'Functions:'            ,
                            -font        => $fontGB2                , );
$winSettings->AddLabel(     -name        => 'lblLocalTZ'            ,
                            -size        => [120, 22]               ,
                            -pos         => [150,173]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => 'Local timezone:'       ,
                            -font        => $font9                  , );
$winSettings->AddCombobox(  -name        => 'cbLocalTZ'             ,
                            -size        => [230,100]               ,
                            -pos         => [325,170]               ,
                            -font        => $font9                  ,
                            -dropdownlist => 1                      ,
                            -vscroll     => 1                       , );
$winSettings->AddLabel(     -name        => 'lblPHSetTypical'       ,
                            -size        => [160, 22]               ,
                            -pos         => [150,203]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => 'Parse headers typical fields:',
                            -font        => $font9                  , );
$winSettings->AddButton(    -name        => 'btnPHSetTypical'       ,
                            -size        => [125, 24]               ,
                            -pos         => [325,200]               ,
                            -text        => 'Select fields...'      ,
                            -font        => $font9                  , );
$winSettings->AddLabel(     -name        => 'lblESetTypical'        ,
                            -size        => [160, 22]               ,
                            -pos         => [150,233]               ,
                            -background  => [255, 255, 255]         ,
                            -text        => 'Extract Typical fields:',
                            -font        => $font9                  , );
$winSettings->AddButton(    -name        => 'btnESetTypical'        ,
                            -size        => [125, 24]               ,
                            -pos         => [325,230]               ,
                            -text        => 'Select fields...'      ,
                            -font        => $font9                  , );
$winSettings->AddCheckbox(  -name        => 'ch6to4'                ,
                            -size        => [250, 20]               ,
                            -pos         => [150,260]               ,
                            -text        => 'Convert 6to4 addresses (2002::/16) to IPv4',
                            -background  => [255, 255, 255]         ,
                            -font        => $font9                  ,
                            -checked     => 1                       , );

# Databases tab

# XL-Whois
$winSettings->AddLabel(     -name        => 'lblXLWHOISDBShadowT'   ,
                            -size        => [250, 22]               ,
                            -pos         => [151, 36]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => 'XL-Whois database:'    ,
                            -font        => $fontGB2                ,
                            -visible     => 0                       , );
$winSettings->AddLabel(     -name        => 'lblXLWHOISDBT'         ,
                            -size        => [250, 22]               ,
                            -pos         => [150, 35]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [ 92, 172, 238]         ,
                            -text        => 'XL-Whois database:'    ,
                            -font        => $fontGB2                ,
                            -visible     => 0                       , );
$winSettings->AddTextfield( -name        => 'tfXLWHOISDB'           ,
                            -size        => [412, 22]               ,
                            -pos         => [150, 68]               ,
                            -visible     => 0                       , );
$winSettings->AddButton(    -name        => 'btnXLWHOISDB'          ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565, 68]               ,
                            -bitmap      => $$refIMG{openFile16}    ,
                            -tip         => 'Select the database file',
                            -visible     => 0                       , );
# GeoIP
$winSettings->AddLabel(     -name        => 'lblGeoIPDBShadowT'     ,
                            -size        => [250, 22]               ,
                            -pos         => [151, 99]               ,
                            -foreground  => [180, 180, 180]         ,
                            -background  => [255, 255, 255]         ,
                            -text        => 'GeoIP database:'       ,
                            -font        => $fontGB2                ,
                            -visible     => 0                       , );
$winSettings->AddLabel(     -name        => 'lblGeoIPDBT'           ,
                            -size        => [250, 22]               ,
                            -pos         => [150, 98]               ,
                            -addstyle    => 11                      , # Transparent
                            -foreground  => [ 92, 172, 238]         ,
                            -text        => 'GeoIP database:'       ,
                            -font        => $fontGB2                ,
                            -visible     => 0                       , );
$winSettings->AddTextfield( -name        => 'tfGeoIPDB'             ,
                            -size        => [412, 22]               ,
                            -pos         => [150,128]               ,
                            -visible     => 0                       , );
$winSettings->AddButton(    -name        => 'btnGeoIPDB'            ,
                            -size        => [ 22, 22]               ,
                            -pos         => [565,128]               ,
                            -bitmap      => $$refIMG{openFile16}    ,
                            -tip         => 'Select the database file',
                            -visible     => 0                       , );
$winSettings->AddLabel(     -name        => 'lblGeoIPNotice'        ,
                            -size        => [420, 44]               ,
                            -pos         => [150,155]               ,
                            -background  => [255, 255, 255]         ,
                            -foreground  => [ 80,  80,  80]         ,
                            -text        => 'This product includes GeoLite2 data created by MaxMind, available from https://www.maxmind.com.',
                            -font        => $font9                  , );
#------------------------------------------------------------------------------#
# Select fields window
#------------------------------------------------------------------------------#
my $winFields = Win32::GUI::DialogBox->new(
  -name        => 'winFields'             ,
  -parent      => $win                    ,
  -text        => 'Settings'              ,
  -pos         => [$winPosX, $winPosY]    ,
  -size        => [225, 360]              ,
  -background  => [255, 255, 255]         ,
  -hasmaximize => 0                       ,
  -hasminimize => 0                       ,
  -helpbutton  => 0                       ,
  -resizable   => 0                       ,
  -dialogui    => 1                       , );
$winFields->SetIcon($$refIMG{ico});
$winFields->AddButton(    -name        => 'btnFieldSelAll'        ,
                          -size        => [105, 22]               ,
                          -pos         => [  5,  5]               ,
                          -font        => $font9                  ,
                          -text        => 'Select all'            , );
$winFields->AddButton(    -name        => 'btnFieldUnSelAll'      ,
                          -size        => [105, 22]               ,
                          -pos         => [110,  5]               ,
                          -font        => $font9                  ,
                          -text        => 'Unselect all'          , );
$winFields->AddListView(  -name        => 'lvFieldsSel'           ,
                          -size        => [210,260]               ,
                          -pos         => [  5, 30]               ,
                          -font        => $font8                  ,
                          -background  => [255, 255, 255]         ,
                          -checkboxes  => 1                       ,
                          -gridlines   => 0                       ,
                          -hottrack    => 1                       ,
                          -nocolumnheader => 1                    , );
$winFields->lvFieldsSel->InsertColumn(-width => 215, index => 0, -text => 'Col',);
$winFields->AddLabel(     -name        => 'lblFieldXNote'         ,
                          -size        => [200, 44]               ,
                          -pos         => [  5,295]               ,
                          -background  => [255, 255, 255]         ,
                          -text        => 'Note: X-_Fields_ include all available fields beginning with "X-".',
                          -font        => $font9                  , );
#------------------------------------------------------------------------------#
# Launch the program
#------------------------------------------------------------------------------#
# List of timezone
my @listTZ = DateTime::TimeZone->all_names;
foreach (@listTZ) { $winSettings->cbLocalTZ->Add($_); }
&loadSettings();
if ($SETTINGS{'TOOL_AUTO_UPDATE'}) { $THR_UPDATE = threads->create(sub { sleep(2); &updateTool(0); }); }
$win->tfInput->Text($$REF_ARG[0]) if $$REF_ARG[0] and -d $$REF_ARG[0]; # If started with Send to
$GUI{START} = 1;
&isProcessReady(0);
$win->Show();
Win32::GUI::Dialog();
#--------------------------#
sub winMain_Resize
#--------------------------#
{
	# Resize and move controls
  $win->lblHeader->Width($win->ScaleWidth()-48);
  $win->lblInputT->Width($win->ScaleWidth());
  $win->tfInput->Width($win->ScaleWidth()-158);
  $win->btnInput->Left($win->ScaleWidth()-151);
  $win->chInputDirRecurse->Left($win->ScaleWidth()-125);
  $win->lblFunctionsT->Width($win->ScaleWidth());
  $win->TabFunctions->Width($win->ScaleWidth()+3);
  $win->lblReport->Top($win->ScaleHeight()-132);
  $win->cbReportFormat->Top($win->ScaleHeight()-135);
  $win->lblXLXSMaxWidth->Top($win->ScaleHeight()-132);
  $win->tfXLXSMaxWidth->Top($win->ScaleHeight()-135);
  $win->upXLXSMaxWidth->Top($win->ScaleHeight()-135);
  $win->lblCSVSepar->Top($win->ScaleHeight()-132);
  $win->cbCSVSepar->Top($win->ScaleHeight()-135);
  $win->chESource->Top($win->ScaleHeight()-132);
  $win->chEMsgFolder->Top($win->ScaleHeight()-132);
  $win->lblSTermsOk->Width($win->ScaleWidth()-122);
  $win->lblSTermsErr->Width($win->ScaleWidth()-122);
  $win->lblSTermsWarn->Width($win->ScaleWidth()-122);
  $win->tfSTerms->Width($win->ScaleWidth()-124);
  # Report
  $win->lblDestDir->Top($win->ScaleHeight()-104);
  $win->tfDestDir->Top($win->ScaleHeight()-107);
  $win->tfDestDir->Width($win->ScaleWidth()-170);
  $win->btnSelDestDir->Top($win->ScaleHeight()-107);
  $win->btnSelDestDir->Left($win->ScaleWidth()-63);
  $win->btnOpenSelDir->Top($win->ScaleHeight()-107);
  $win->btnOpenSelDir->Left($win->ScaleWidth()-40);
  $win->chOpenAtEnd->Top($win->ScaleHeight()-80);  
  # Footer
  $win->lblFooter->Top($win->ScaleHeight()-55);
  $win->lblFooter->Width($win->ScaleWidth());
  $win->lblNotReady->Top($win->ScaleHeight()-40);
  $win->lblPbCurr->Top($win->ScaleHeight()-48);
  $win->lblPbCurr->Width($win->ScaleWidth()-240);
  $win->pb->Top($win->ScaleHeight()-27);
  $win->pb->Width($win->ScaleWidth()-330);
  $win->lblPbCount->Top($win->ScaleHeight()-25);
  $win->lblPbCount->Left($win->ScaleWidth()-315);
  $win->btnProcess->Move($win->ScaleWidth()-180, $win->ScaleHeight()-45);
  $win->btnStop->Move($win->ScaleWidth()-180, $win->ScaleHeight()-45);
  $win->btnWinSettings->Move($win->ScaleWidth()-135, $win->ScaleHeight()-45);
  $win->btnHelp->Move($win->ScaleWidth()-90, $win->ScaleHeight()-45);
  $win->btnAbout->Move($win->ScaleWidth()-45, $win->ScaleHeight()-45);
  
}  #--- End winMain_Resize

#------------------------------------------------------------------------------#
# Functions
#------------------------------------------------------------------------------#
#--------------------------#
sub tfInput_Change { &isProcessReady(0); }
#--------------------------#
#--------------------------#
sub btnInput_Click {
#--------------------------#
  my $dir;
	# Show dialog window
	if (my $lastDir = $win->tfInput->Text()) {
		my(@parts) = split(/\\/, $lastDir);
		if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
		$dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => 'Select a directory:', -folderonly => 1, -directory => $lastDir);
	} else {
		$dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => 'Select a directory:', -folderonly => 1);
	}
	if ($dir and -d $dir) { # Selected folder
		chop($dir) if $dir =~ /\\$/;
		$win->tfInput->Text($dir);
	}
  return(1);
  
}  #--- End btnInput_Click
#--------------------------#
sub chInputMSG_Click { &isProcessReady(0); }
sub chInputEML_Click { &isProcessReady(0); }
#--------------------------#
#--------------------------#
sub TabFunctions_Click {
#--------------------------#
  # Show Parse Headers tab
  if (!$win->TabFunctions->SelectedItem()) {
    $win->lblPHFields->Show();
    $win->rbPHTypical->Show();
    $win->rbPHAll->Show();
    $win->rbPHChoose->Show();
    $win->btnPHSelect->Show();
    $win->chPHAllReceived->Show();
    $win->chPHDatetime->Show();
    $win->lblPHAdd->Show();
    $win->chPHSourceFile->Show();
    $win->chPHAttachList->Show();
    $win->chPHNSLookup->Show();
    $win->chPHISP->Show();
    $win->chPHGeoIP->Show();
    $win->lblReport->Show();
    $win->cbReportFormat->Show();
    &cbReportFormat_Change();
    # Hide Extract tab
    $win->chEHeaders->Hide();
    $win->rbETypical->Hide();
    $win->rbEAll->Hide();
    $win->rbEChoose->Hide();
    $win->btnESelect->Hide();
    $win->chEBody->Hide();
    $win->chEBodyText->Hide();
    $win->chEBodyHTML->Hide();
    $win->chEBodyMerge->Hide();
    $win->chEAttach->Hide();
    $win->rbEAttachAll->Hide();
    $win->rbEAttachImg->Hide();
    $win->rbEAttachExt->Hide();
    $win->tfEAttachExt->Hide();
    $win->chESource->Hide();
    $win->chEMsgFolder->Hide();    
    # Hide Search tab
    $win->rbSAll->Hide();
    $win->rbSHeader->Hide();
    $win->rbSBody->Hide();
    $win->lblSBodyLeft->Hide();
    $win->chSBodyText->Hide();
    $win->chSBodyHTML->Hide();
    $win->chSSource->Hide();
    $win->chSCase->Hide();
    $win->chSRegex->Hide();
    $win->lblSTerms->Hide();
    $win->tfSTerms->Hide();
    $win->lblSTermsOk->Hide();
    $win->lblSTermsErr->Hide();
    $win->lblSTermsWarn->Hide();
    # Hide Gephi tab
    $win->chGReceived->Hide();
    $win->rbGRecvIP->Hide();
    $win->rbGRecvHost->Hide();
    $win->rbGRecvBoth->Hide();
    $win->rbGRecvFrom->Hide();
    $win->rbGRecvBy->Hide();
    $win->rbGRecvFB->Hide();
    $win->chGEmails->Hide();
    $win->rbGEmailName->Hide();
    $win->rbGEmailAddr->Hide();
    $win->rbGEmailBoth->Hide();    
  # Show Extract tab
  } elsif ($win->TabFunctions->SelectedItem() == 1) {
    $win->chEHeaders->Show();
    $win->rbETypical->Show();
    $win->rbEAll->Show();
    $win->rbEChoose->Show();
    $win->btnESelect->Show();
    $win->chEBody->Show();
    $win->chEBodyText->Show();
    $win->chEBodyHTML->Show();
    $win->chEBodyMerge->Show();
    $win->chEAttach->Show();
    $win->rbEAttachAll->Show();
    $win->rbEAttachImg->Show();
    $win->rbEAttachExt->Show();
    $win->tfEAttachExt->Show();
    $win->chESource->Show();
    $win->chEMsgFolder->Show();   
    # Hide Parse headers tab
    $win->lblPHFields->Hide();
    $win->rbPHTypical->Hide();
    $win->rbPHAll->Hide();
    $win->rbPHChoose->Hide();
    $win->btnPHSelect->Hide();
    $win->chPHAllReceived->Hide();
    $win->chPHDatetime->Hide();
    $win->lblPHAdd->Hide();
    $win->chPHSourceFile->Hide();
    $win->chPHAttachList->Hide();
    $win->chPHNSLookup->Hide();
    $win->chPHISP->Hide();
    $win->chPHGeoIP->Hide();
    $win->lblReport->Hide();
    $win->cbReportFormat->Hide();
    $win->lblXLXSMaxWidth->Hide();
    $win->tfXLXSMaxWidth->Hide();
    $win->upXLXSMaxWidth->Hide();
    $win->lblCSVSepar->Hide();
    $win->cbCSVSepar->Hide();
    # Hide Search tab
    $win->rbSAll->Hide();
    $win->rbSHeader->Hide();
    $win->rbSBody->Hide();
    $win->lblSBodyLeft->Hide();
    $win->chSBodyText->Hide();
    $win->chSBodyHTML->Hide();
    $win->chSSource->Hide();
    $win->chSCase->Hide();
    $win->chSRegex->Hide();
    $win->lblSTerms->Hide();
    $win->tfSTerms->Hide();
    $win->lblSTermsOk->Hide();
    $win->lblSTermsErr->Hide();
    $win->lblSTermsWarn->Hide();
    # Hide Gephi tab
    $win->chGReceived->Hide();
    $win->rbGRecvIP->Hide();
    $win->rbGRecvHost->Hide();
    $win->rbGRecvBoth->Hide();
    $win->rbGRecvFrom->Hide();
    $win->rbGRecvBy->Hide();
    $win->rbGRecvFB->Hide();
    $win->chGEmails->Hide();
    $win->rbGEmailName->Hide();
    $win->rbGEmailAddr->Hide();
    $win->rbGEmailBoth->Hide();    
  # Show Search tab
  } elsif ($win->TabFunctions->SelectedItem() == 2) {
    $win->rbSAll->Show();
    $win->rbSHeader->Show();
    $win->rbSBody->Show();
    $win->lblSBodyLeft->Show();
    $win->chSBodyText->Show();
    $win->chSBodyHTML->Show();
    $win->chSSource->Show();
    $win->chSCase->Show();
    $win->chSRegex->Show();
    $win->lblSTerms->Show();
    $win->tfSTerms->Show();
    &tfSTerms_Change() if $win->chSRegex->Checked();
    # Hide Parse headers tab
    $win->lblPHFields->Hide();
    $win->rbPHTypical->Hide();
    $win->rbPHAll->Hide();
    $win->rbPHChoose->Hide();
    $win->btnPHSelect->Hide();
    $win->chPHAllReceived->Hide();
    $win->chPHDatetime->Hide();
    $win->lblPHAdd->Hide();
    $win->chPHSourceFile->Hide();
    $win->chPHAttachList->Hide();
    $win->chPHNSLookup->Hide();
    $win->chPHISP->Hide();
    $win->chPHGeoIP->Hide();
    $win->lblReport->Hide();
    $win->cbReportFormat->Hide();
    $win->lblXLXSMaxWidth->Hide();
    $win->tfXLXSMaxWidth->Hide();
    $win->upXLXSMaxWidth->Hide();
    $win->lblCSVSepar->Hide();
    $win->cbCSVSepar->Hide();
    # Hide Extract tab
    $win->chEHeaders->Hide();
    $win->rbETypical->Hide();
    $win->rbEAll->Hide();
    $win->rbEChoose->Hide();
    $win->btnESelect->Hide();
    $win->chEBody->Hide();
    $win->chEBodyText->Hide();
    $win->chEBodyHTML->Hide();
    $win->chEBodyMerge->Hide();
    $win->chEAttach->Hide();
    $win->rbEAttachAll->Hide();
    $win->rbEAttachImg->Hide();
    $win->rbEAttachExt->Hide();
    $win->tfEAttachExt->Hide();
    $win->chESource->Hide();
    $win->chEMsgFolder->Hide();
    # Hide Gephi tab
    $win->chGReceived->Hide();
    $win->rbGRecvIP->Hide();
    $win->rbGRecvHost->Hide();
    $win->rbGRecvBoth->Hide();
    $win->rbGRecvFrom->Hide();
    $win->rbGRecvBy->Hide();
    $win->rbGRecvFB->Hide();
    $win->chGEmails->Hide();
    $win->rbGEmailName->Hide();
    $win->rbGEmailAddr->Hide();
    $win->rbGEmailBoth->Hide();    
  # Show Gephi tab
  } elsif ($win->TabFunctions->SelectedItem() == 3) {
    $win->chGReceived->Show();
    $win->rbGRecvIP->Show();
    $win->rbGRecvHost->Show();
    $win->rbGRecvBoth->Show();
    $win->rbGRecvFrom->Show();
    $win->rbGRecvBy->Show();
    $win->rbGRecvFB->Show();
    $win->chGEmails->Show();
    $win->rbGEmailName->Show();
    $win->rbGEmailAddr->Show();
    $win->rbGEmailBoth->Show();    
    # Hide Parse headers tab
    $win->lblPHFields->Hide();
    $win->rbPHTypical->Hide();
    $win->rbPHAll->Hide();
    $win->rbPHChoose->Hide();
    $win->btnPHSelect->Hide();
    $win->chPHAllReceived->Hide();
    $win->chPHDatetime->Hide();
    $win->lblPHAdd->Hide();
    $win->chPHSourceFile->Hide();
    $win->chPHAttachList->Hide();
    $win->chPHNSLookup->Hide();
    $win->chPHISP->Hide();
    $win->chPHGeoIP->Hide();
    $win->lblReport->Hide();
    $win->cbReportFormat->Hide();
    $win->lblXLXSMaxWidth->Hide();
    $win->tfXLXSMaxWidth->Hide();
    $win->upXLXSMaxWidth->Hide();
    $win->lblCSVSepar->Hide();
    $win->cbCSVSepar->Hide();
    # Hide Extract tab
    $win->chEHeaders->Hide();
    $win->rbETypical->Hide();
    $win->rbEAll->Hide();
    $win->rbEChoose->Hide();
    $win->btnESelect->Hide();
    $win->chEBody->Hide();
    $win->chEBodyText->Hide();
    $win->chEBodyHTML->Hide();
    $win->chEBodyMerge->Hide();
    $win->chEAttach->Hide();
    $win->rbEAttachAll->Hide();
    $win->rbEAttachImg->Hide();
    $win->rbEAttachExt->Hide();
    $win->tfEAttachExt->Hide();
    $win->chESource->Hide();
    $win->chEMsgFolder->Hide();
    # Hide Search tab
    $win->rbSAll->Hide();
    $win->rbSHeader->Hide();
    $win->rbSBody->Hide();
    $win->lblSBodyLeft->Hide();
    $win->chSBodyText->Hide();
    $win->chSBodyHTML->Hide();
    $win->chSSource->Hide();
    $win->chSCase->Hide();
    $win->chSRegex->Hide();
    $win->lblSTerms->Hide();
    $win->tfSTerms->Hide();
    $win->lblSTermsOk->Hide();
    $win->lblSTermsErr->Hide();
    $win->lblSTermsWarn->Hide();
  }
  &isProcessReady(0);
}  #--- End TabFunctions_Click
#--------------------------#
sub rbPHTypical_Click { &rbPH_Changed(); }
sub rbPHAll_Click     { &rbPH_Changed(); }
sub rbPHChoose_Click  { &rbPH_Changed(); }
sub rbPH_Changed {
#--------------------------#
  if ($win->rbPHChoose->Checked) { $win->btnPHSelect->Enable();  }
  else                           { $win->btnPHSelect->Disable(); }
  &isProcessReady(0);
  return(1);
}  #--- End rbPH_Changed
#--------------------------#
sub btnPHSelect_Click {
#--------------------------#
  for (my $i = 0; $i < $winFields->lvFieldsSel->Count(); $i++) {
    my %field = $winFields->lvFieldsSel->GetItem($i);
    if (exists($FIELDS{PH_SEL}{$field{-text}}) and $FIELDS{PH_SEL}{$field{-text}} == 1) {
      $winFields->lvFieldsSel->ItemCheck($i, 1);
    } else { $winFields->lvFieldsSel->ItemCheck($i, 0); }
  }
  $FIELDS_WIN_CALLER = 'PH';
  $winFields->Center($win);
  $winFields->Show();
  $win->Disable();
  return(1);
}  #--- End btnPHSelect_Click
#--------------------------#
sub btnFieldSelAll_Click {
#--------------------------#
  for (my $i = 0; $i < $winFields->lvFieldsSel->Count(); $i++) {
    $winFields->lvFieldsSel->ItemCheck($i, 1);
  }
  &isProcessReady(0);
  return(1);
}  #--- End btnFieldSelAll_Click
#--------------------------#
sub btnFieldUnSelAll_Click {
#--------------------------#
  for (my $i = 0; $i < $winFields->lvFieldsSel->Count(); $i++) {
    $winFields->lvFieldsSel->ItemCheck($i, 0);
  }
  &isProcessReady(0);
  return(1);
}  #--- End btnFieldUnSelAll_Click
#--------------------------#
sub winFields_Terminate {
#--------------------------#
  for (my $i = 0; $i < $winFields->lvFieldsSel->Count(); $i++) {
    my %field = $winFields->lvFieldsSel->GetItem($i);
    my $state = $winFields->lvFieldsSel->GetCheckState($i);
    if    ($FIELDS_WIN_CALLER eq 'PH' ) { $FIELDS{PH_SEL}{$field{-text}}  = $state; }
    elsif ($FIELDS_WIN_CALLER eq 'E'  ) { $FIELDS{E_SEL}{$field{-text}}   = $state; }
    elsif ($FIELDS_WIN_CALLER eq 'PHT') { $FIELDS{PHT_SEL}{$field{-text}} = $state; }
    elsif ($FIELDS_WIN_CALLER eq 'ET' ) { $FIELDS{ET_SEL}{$field{-text}}  = $state; }
  }
  &saveSettings() if $FIELDS_WIN_CALLER eq 'PHT' or $FIELDS_WIN_CALLER eq 'ET';
  &isProcessReady(0);
  $winFields->Hide();
  $win->Enable();
  $win->BringWindowToTop();
  return(0);
}  #--- End winFields_Terminate
#--------------------------#
sub cbReportFormat_Change {
#--------------------------#
  my $format = $win->cbReportFormat->GetCurSel();
  if (!$format) { # XLSX
    $win->lblXLXSMaxWidth->Show();
    $win->tfXLXSMaxWidth->Show();
    $win->upXLXSMaxWidth->Show();
    $win->lblCSVSepar->Hide();
    $win->cbCSVSepar->Hide();
  } elsif ($format == 2) { # CSV
    $win->lblCSVSepar->Show();
    $win->cbCSVSepar->Show();
    $win->lblXLXSMaxWidth->Hide();
    $win->tfXLXSMaxWidth->Hide();
    $win->upXLXSMaxWidth->Hide();
  } else {
    $win->lblXLXSMaxWidth->Hide();
    $win->tfXLXSMaxWidth->Hide();
    $win->upXLXSMaxWidth->Hide();
    $win->lblCSVSepar->Hide();
    $win->cbCSVSepar->Hide();
  }
  # Remember
  $SETTINGS{REPORT_FORMAT} = $format;
  &saveSettings();
}  #--- End cbReportFormat_Change
#--------------------------#
sub tfXLXSMaxWidth_Change {
#--------------------------#
  if ($GUI{START}) {
    my $maxWidth = $win->tfXLXSMaxWidth->Text();
    # Remember
    if ($maxWidth) {
      $SETTINGS{XLSX_MAX_WIDTH} = $maxWidth;
      &saveSettings();
    } else {
      delete($SETTINGS{XLSX_MAX_WIDTH});
      &saveSettings();
    }
    &isProcessReady(0);
  }
}  #--- End tfXLXSMaxWidth_Change
#--------------------------#
sub cbCSVSepar_Change {
#--------------------------#
  $SETTINGS{CSV_SEPARATOR} = $win->cbCSVSepar->GetCurSel();
  &saveSettings();
}  #--- End cbCSVSepar_Change
#--------------------------#
sub tfDestDir_Change {
#--------------------------#
  if ($GUI{START}) {
    my $saveDir = $win->tfDestDir->Text();
    # Remember
    if ($saveDir and -d $saveDir) {
      $SETTINGS{DEST_DIR} = $saveDir;
      &saveSettings();
    } else { # Invalid file or no file
      delete($SETTINGS{DEST_DIR});
      &saveSettings();
      if ($saveDir) {
        $win->tfDestDir->Text('');
        Win32::GUI::MessageBox($win, 'You must enter a valid directory.', 'Error', 0x40010);
      }
    }
    &isProcessReady(0);
  }
}  #--- End tfDestDir_Change
#--------------------------#
sub btnSelDestDir_Click {
#--------------------------#
  my $dir;
  # Show BrowseForFolder dialog window
  if (my $lastDir = $win->tfDestDir->Text()) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => 'Select a directory:', -folderonly => 1, -newui => 1, -directory  => $lastDir);
  } else {
    $dir = Win32::GUI::BrowseForFolder(-owner => $win, -title => 'Select a directory:', -folderonly => 1, -newui => 1);
  }
  if ($dir and -d $dir) { # Selected folder
    chop($dir) if $dir =~ /\\$/;
    $win->tfDestDir->Text($dir);
  }
  return(1);  
}  #--- End btnSelDestDir_Click
#--------------------------#
sub btnOpenSelDir_Click {
#--------------------------#
  if (my $outputDir = $win->tfDestDir->Text() and -d $win->tfDestDir->Text()) { # Open Window Explorer
		Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $outputDir", 0, NORMAL_PRIORITY_CLASS, ".");
	}
}  #--- End btnOpenSelDir_Click
#--------------------------#
sub chOpenAtEnd_Click {
#--------------------------#
  if ($win->chOpenAtEnd->Checked()) {
    $SETTINGS{AUTO_OPEN_REPORT} = 1;
    &saveSettings();
  } else {
    $SETTINGS{AUTO_OPEN_REPORT} = 0;
    &saveSettings();
  }
}  #--- End chOpenAtEnd_Click
#--------------------------#
sub chEHeaders_Click {
#--------------------------#
  if ($win->chEHeaders->Checked) {
    $win->rbETypical->Enable();
    $win->rbEAll->Enable();
    $win->rbEChoose->Enable();
    if ($win->chEBody->Checked) { $win->chEBodyMerge->Enable();  }
    else                        { $win->chEBodyMerge->Disable(); }
  } else {
    $win->rbETypical->Disable();
    $win->rbEAll->Disable();
    $win->rbEChoose->Disable();
    $win->chEBodyMerge->Disable();
  }
  &isProcessReady(0);
  return(1);
}  #--- End chEHeaders_Click
#--------------------------#
sub rbETypical_Click { &rbE_Changed(); }
sub rbEAll_Click     { &rbE_Changed(); }
sub rbEChoose_Click  { &rbE_Changed(); }
sub rbE_Changed {
#--------------------------#
  if ($win->rbEChoose->Checked) { $win->btnESelect->Enable();  }
  else                          { $win->btnESelect->Disable(); }
  &isProcessReady(0);
  return(1);
}  #--- End rbE_Changed
#--------------------------#
sub btnESelect_Click {
#--------------------------#
  for (my $i = 0; $i < $winFields->lvFieldsSel->Count(); $i++) {
    my %field = $winFields->lvFieldsSel->GetItem($i);
    if (exists($FIELDS{E_SEL}{$field{-text}}) and $FIELDS{E_SEL}{$field{-text}} == 1) {
      $winFields->lvFieldsSel->ItemCheck($i, 1);
    } else { $winFields->lvFieldsSel->ItemCheck($i, 0); }
  }
  $FIELDS_WIN_CALLER = 'E';
  $winFields->Center($win);
  $winFields->Show();
  $win->Disable();
}  #--- End btnESelect_Click
#--------------------------#
sub chEBody_Click {
#--------------------------#
  if ($win->chEBody->Checked) {
    $win->chEBodyText->Enable();
    $win->chEBodyHTML->Enable();
    if ($win->chEHeaders->Checked) { $win->chEBodyMerge->Enable();  }
    else                           { $win->chEBodyMerge->Disable(); }
  } else {
    $win->chEBodyText->Disable();
    $win->chEBodyHTML->Disable();
    $win->chEBodyMerge->Disable();
  }
  &isProcessReady(0);
  return(1);
}  #--- End chEBody_Click
#--------------------------#
sub chEBodyText_Click { &isProcessReady(0); }
sub chEBodyHTML_Click { &isProcessReady(0); }
#--------------------------#
#--------------------------#
sub chEAttach_Click {
#--------------------------#
  if ($win->chEAttach->Checked) {
    $win->rbEAttachAll->Enable();
    $win->rbEAttachImg->Enable();
    $win->rbEAttachExt->Enable();
    if ($win->rbEAttachExt->Checked) { $win->tfEAttachExt->Enable();  }
    else                             { $win->tfEAttachExt->Disable(); }
    $win->chESource->Enable();
  } else {
    $win->rbEAttachAll->Disable();
    $win->rbEAttachImg->Disable();
    $win->rbEAttachExt->Disable();
    $win->tfEAttachExt->Disable();
    $win->chESource->Disable();
  }
  &isProcessReady(0);
  return(1);
}  #--- End chEAttach_Click
#--------------------------#
sub rbEAttachAll_Click { &rbEA_Changed(); }
sub rbEAttachImg_Click { &rbEA_Changed(); }
sub rbEAttachExt_Click { &rbEA_Changed(); }
sub rbEA_Changed {
#--------------------------#
  if ($win->rbEAttachExt->Checked) { $win->tfEAttachExt->Enable();  }
  else                             { $win->tfEAttachExt->Disable(); }
  &isProcessReady(0);
  return(1);
}  #--- End rbEA_Changed
#--------------------------#
sub tfEAttachExt_Change { &isProcessReady(0); }
#--------------------------#
#--------------------------#
sub rbSAll_Click    { &rbS_Changed(); }
sub rbSHeader_Click { &rbS_Changed(); }
sub rbSBody_Click   { &rbS_Changed(); }
sub rbS_Changed {
#--------------------------#
  if ($win->rbSHeader->Checked) {
    $win->lblSBodyLeft->Disable();
    $win->chSBodyText->Disable();
    $win->chSBodyHTML->Disable();
  } else {
    $win->lblSBodyLeft->Enable();
    $win->chSBodyText->Enable();
    $win->chSBodyHTML->Enable();
  }
  &isProcessReady(0);
  return(1);
}  #--- End rbS_Changed
#--------------------------#
sub chSBodyText_Click { &isProcessReady(0); }
sub chSBodyHTML_Click { &isProcessReady(0); }
#--------------------------#
#--------------------------#
sub chSRegex_Click { &tfSTerms_Change(); }
#--------------------------#
#--------------------------#
sub tfSTerms_Change {
#--------------------------#
  if ($win->chSRegex->Checked() and my $regex = $win->tfSTerms->Text()) {
    my ($statusRegex, $msg) = &validRegex($regex);
    # Warning
    if      ($statusRegex == 2) {
      $win->lblSTermsWarn->Show();
      $win->lblSTermsOk->Hide();
      $win->lblSTermsErr->Hide();
    # Error
    } elsif ($statusRegex) {
      $win->lblSTermsErr->Show();
      $win->lblSTermsOk->Hide();
      $win->lblSTermsWarn->Hide();
    # Ok
    } else {
      $win->lblSTermsOk->Show();
      $win->lblSTermsErr->Hide();
      $win->lblSTermsWarn->Hide();
    }
  } else {
    $win->lblSTermsOk->Hide();
    $win->lblSTermsErr->Hide();
    $win->lblSTermsWarn->Hide();
  }
  &isProcessReady(0);
  return(1);
}  #--- End tfSTerms_Change
#--------------------------#
sub chGReceived_Click {
#--------------------------#
  if ($win->chGReceived->Checked()) {
    $win->rbGRecvIP->Enable();
    $win->rbGRecvHost->Enable();
    $win->rbGRecvBoth->Enable();
    $win->rbGRecvFrom->Enable();
    $win->rbGRecvBy->Enable();
    $win->rbGRecvFB->Enable();
  } else {
    $win->rbGRecvIP->Disable();
    $win->rbGRecvHost->Disable();
    $win->rbGRecvBoth->Disable();
    $win->rbGRecvFrom->Disable();
    $win->rbGRecvBy->Disable();
    $win->rbGRecvFB->Disable();
  }
  &isProcessReady(0);
  return(1);
}  #--- End chGReceived_Click
#--------------------------#
sub chGEmails_Click {
#--------------------------#
  if ($win->chGEmails->Checked()) {
    $win->rbGEmailName->Enable();
    $win->rbGEmailAddr->Enable();
    $win->rbGEmailBoth->Enable();
  } else {
    $win->rbGEmailName->Disable();
    $win->rbGEmailAddr->Disable();
    $win->rbGEmailBoth->Disable();
  }
  &isProcessReady(0);
  return(1);
}  #--- End chGEmails_Click
#--------------------------#
sub btnWinSettings_Click {
#--------------------------#
  # Show Settings window with General Tab
  $winSettings->settingsTab->SetCurSel(0);
  &settingsTab_Click;
  $winSettings->Center($win);
  $winSettings->DoModal();
}  #--- End btnWinSettings_Click
#--------------------------#
sub settingsTab_Click {
#--------------------------#
  # Show General tab
  if (!$winSettings->settingsTab->SelectedItem()) {
    if (-T $LOGGING_FILE) { $winSettings->btnOpenLog->Enable();  }
    else                  { $winSettings->btnOpenLog->Disable(); }
    $winSettings->lblToolShadowT->Show();
    $winSettings->lblToolT->Show();
    $winSettings->btnOpenUserDir->Show();
    $winSettings->btnCheckUpdate->Show();
    $winSettings->chAutoUpdate->Show();
    $winSettings->btnOpenLog->Show();
    $winSettings->chLogging->Show();
    $winSettings->lblFuncShadowT->Show();
    $winSettings->lblFuncT->Show();
    $winSettings->lblLocalTZ->Show();
    $winSettings->cbLocalTZ->Show();
    $winSettings->lblPHSetTypical->Show();
    $winSettings->btnPHSetTypical->Show();
    $winSettings->lblESetTypical->Show();
    $winSettings->btnESetTypical->Show();
    $winSettings->ch6to4->Show();
    # Hide Databases tab
    $winSettings->lblXLWHOISDBShadowT->Hide();
    $winSettings->lblXLWHOISDBT->Hide();
    $winSettings->tfXLWHOISDB->Hide();
    $winSettings->btnXLWHOISDB->Hide();
    $winSettings->lblGeoIPDBShadowT->Hide();
    $winSettings->lblGeoIPDBT->Hide();
    $winSettings->tfGeoIPDB->Hide();
    $winSettings->btnGeoIPDB->Hide();
    $winSettings->lblGeoIPNotice->Hide();
  # Show Databases tab
  } else { 
    $winSettings->lblXLWHOISDBShadowT->Show();
    $winSettings->lblXLWHOISDBT->Show();
    $winSettings->tfXLWHOISDB->Show();
    $winSettings->btnXLWHOISDB->Show();
    $winSettings->lblGeoIPDBShadowT->Show();
    $winSettings->lblGeoIPDBT->Show();
    $winSettings->tfGeoIPDB->Show();
    $winSettings->btnGeoIPDB->Show();
    $winSettings->lblGeoIPNotice->Show();
    # Hide General tab
    $winSettings->lblToolShadowT->Hide();
    $winSettings->lblToolT->Hide();
    $winSettings->btnOpenUserDir->Hide();
    $winSettings->btnCheckUpdate->Hide();
    $winSettings->chAutoUpdate->Hide();
    $winSettings->btnOpenLog->Hide();
    $winSettings->chLogging->Hide();
    $winSettings->lblFuncShadowT->Hide();
    $winSettings->lblFuncT->Hide();
    $winSettings->lblLocalTZ->Hide();
    $winSettings->cbLocalTZ->Hide();
    $winSettings->lblPHSetTypical->Hide();
    $winSettings->btnPHSetTypical->Hide();
    $winSettings->lblESetTypical->Hide();
    $winSettings->btnESetTypical->Hide();
    $winSettings->ch6to4->Hide();
  }
}  #--- End settingsTab_Click
#--------------------------#
sub btnOpenUserDir_Click {
#--------------------------#
  # Open Window Explorer
  Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $USERDIR", 0, NORMAL_PRIORITY_CLASS, ".") if -d $USERDIR;
}  #--- End btnOpenUserDir_Click
#--------------------------#
sub btnCheckUpdate_Click { &updateTool(1); }
#--------------------------#
#--------------------------#
sub chAutoUpdate_Click {
#--------------------------#
  if ($winSettings->chAutoUpdate->Checked()) {
    $SETTINGS{TOOL_AUTO_UPDATE} = 1;
    &saveSettings();
  } else {
    $SETTINGS{TOOL_AUTO_UPDATE} = 0;
    &saveSettings();
  }
}  #--- End chAutoUpdate_Click
#--------------------------#
sub btnOpenLog_Click {
#--------------------------#
  if ($LOGGING_FILE and -T $LOGGING_FILE) {
    $win->ShellExecute('open', $LOGGING_FILE,'','',1) or
    Win32::GUI::MessageBox($win, "Error opening error log: ".Win32::FormatMessage(Win32::GetLastError()), 'Error', 0x40010);
  }
  return(1);
}  #--- End btnOpenLog_Click
#--------------------------#
sub chLogging_Click {
#--------------------------#
  if ($winSettings->chLogging->Checked()) {
    $SETTINGS{LOGGING} = 1;
    &saveSettings();
  } else {
    $SETTINGS{LOGGING} = 0;
    &saveSettings();
  }
}  #--- End chLogging_Click
#--------------------------#
sub cbLocalTZ_Change {
#--------------------------#
  $SETTINGS{LOCAL_TIMEZONE} = $winSettings->cbLocalTZ->GetCurSel();
  &saveSettings();
}  #--- End cbLocalTZ_Change
#--------------------------#
sub btnPHSetTypical_Click {
#--------------------------#
  for (my $i = 0; $i < $winFields->lvFieldsSel->Count(); $i++) {
    my %field = $winFields->lvFieldsSel->GetItem($i);
    if (exists($FIELDS{PHT_SEL}{$field{-text}}) and $FIELDS{PHT_SEL}{$field{-text}} == 1) {
      $winFields->lvFieldsSel->ItemCheck($i, 1);
    } else { $winFields->lvFieldsSel->ItemCheck($i, 0); }
  }
  $FIELDS_WIN_CALLER = 'PHT';
  $winFields->Center($win);
  $winFields->Show();
  $win->Disable();
}  #--- End btnPHSetTypical_Click
#--------------------------#
sub btnESetTypical_Click {
#--------------------------#
  for (my $i = 0; $i < $winFields->lvFieldsSel->Count(); $i++) {
    my %field = $winFields->lvFieldsSel->GetItem($i);
    if (exists($FIELDS{ET_SEL}{$field{-text}}) and $FIELDS{ET_SEL}{$field{-text}} == 1) {
      $winFields->lvFieldsSel->ItemCheck($i, 1);
    } else { $winFields->lvFieldsSel->ItemCheck($i, 0); }
  }
  $FIELDS_WIN_CALLER = 'ET';
  $winFields->Center($win);
  $winFields->Show();
  $win->Disable();
}  #--- End btnESetTypical_Click
#--------------------------#
sub ch6to4_Click {
#--------------------------#
  if ($winSettings->ch6to4->Checked()) {
    $SETTINGS{'6TO4'} = 1;
    &saveSettings();
  } else {
    $SETTINGS{'6TO4'} = 0;
    &saveSettings();
  }
}  #--- End ch6to4_Click
#--------------------------#
sub tfXLWHOISDB_Change {
#--------------------------#
  if ($GUI{START}) {
    my $XLWHOISDBFile = $winSettings->tfXLWHOISDB->Text();
    # Remember
    if ($XLWHOISDBFile and -f $XLWHOISDBFile and &validSQLiteDB($XLWHOISDBFile, 'WHOIS_DB')) {
      $SETTINGS{XLWHOIS_DB} = $XLWHOISDBFile;
      $win->chPHISP->Enable();
      &saveSettings();
    } else {
      delete($SETTINGS{XLWHOIS});
      $win->chPHISP->Disable();
      &saveSettings();
      if ($XLWHOISDBFile) {
        $winSettings->tfXLWHOISDB->Text('');
        Win32::GUI::MessageBox($winSettings, 'You must enter a valid XL-Whois database.', 'Error', 0x40010);
      }
    }
  }
}  #--- End tfXLWHOISDB_Change
#--------------------------#
sub btnXLWHOISDB_Click {
#--------------------------#
  my $XLWHOISDBFile;
  # Show OpenFile dialog window
  if (my $lastDir = $winSettings->tfXLWHOISDB->Text()) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $XLWHOISDBFile = Win32::GUI::GetOpenFileName( -owner         => $winSettings               ,
                                                  -title         => 'Select a valid XL-Whois database:',
                                                  -filter        => ['Database (*.db)' => '*.db'] ,
                                                  -filemustexist => 1                          ,
                                                  -directory     => $lastDir                   ,
                                                  -file          => 'Whois.db'                 ,
                                                  -explorer      => 1                          , );
  } else {
    $XLWHOISDBFile = Win32::GUI::GetOpenFileName( -owner         => $winSettings               ,
                                                  -title         => 'Select a valid XL-Whois database:',
                                                  -filter        => ['Database (*.db)' => '*.db'] ,
                                                  -filemustexist => 1                          ,
                                                  -file          => 'Whois.db'                 ,
                                                  -explorer      => 1                          , );
  }
  $winSettings->tfXLWHOISDB->Text($XLWHOISDBFile) if $XLWHOISDBFile;
  return(1);
}  #--- End btnXLWHOISDB_Click
#--------------------------#
sub tfGeoIPDB_Change {
#--------------------------#
  if ($GUI{START}) {
    my $GeoIPDBFile = $winSettings->tfGeoIPDB->Text();
    # Remember
    if ($GeoIPDBFile and -f $GeoIPDBFile and &validGeoIPDB($GeoIPDBFile)) {
      $SETTINGS{GEOIP_DB} = $GeoIPDBFile;
      $win->chPHGeoIP->Enable();
      &saveSettings();
    } else {
      delete($SETTINGS{GEOIP_DB});
      $win->chPHGeoIP->Disable();
      &saveSettings();
      if ($GeoIPDBFile) {
        $winSettings->tfGeoIPDB->Text('');
        Win32::GUI::MessageBox($winSettings, 'You must enter a valid GeoIP database.', 'Error', 0x40010) if $GUI{START};
      }
    }
  }
}  #--- End tfGeoIPDB_Change
#--------------------------#
sub btnGeoIPDB_Click {
#--------------------------#
  my $GeoIPDBFile;
  # Show OpenFile dialog window
  if (my $lastDir = $winSettings->tfGeoIPDB->Text()) {
    my(@parts) = split(/\\/, $lastDir);
    if (pop(@parts) =~ /\./) { while ($lastDir =~ /[^\\]$/) { chop($lastDir); } }
    $GeoIPDBFile = Win32::GUI::GetOpenFileName( -owner         => $winSettings              ,
                                                -title         => 'Select a valid GeoIP database:',
                                                -filter        => ['Maxmind GeoLite2 DB (*.mmdb)', '*.mmdb'],
                                                -filemustexist => 1                         ,
                                                -directory     => $lastDir                  ,
                                                -file          => 'GeoLite2-City.mmdb'      ,
                                                -explorer      => 1                         , );
  } else {
    $GeoIPDBFile = Win32::GUI::GetOpenFileName( -owner         => $winSettings              ,
                                                -title         => 'Select a valid GeoIP database:',
                                                -filter        => ['Maxmind GeoLite2 DB (*.mmdb)', '*.mmdb'],
                                                -filemustexist => 1                         ,
                                                -file          => 'GeoLite2-City.mmdb'      ,
                                                -explorer      => 1                         , );
  }
  $winSettings->tfGeoIPDB->Text($GeoIPDBFile) if $GeoIPDBFile;
  return(1);
}  #--- End btnGeoIPDB_Click
#--------------------------#
sub btnHelp_Click {
#--------------------------#
  # Open XL-ParseMails documentation page with default browser
  $win->ShellExecute('open', $URL_DOC,'','',1) or
  Win32::GUI::MessageBox($win, Win32::FormatMessage(Win32::GetLastError()), "XL-ParseMails", 0x40010);
}  #--- End btnHelp_Click
#--------------------------#
sub btnAbout_Click {
#--------------------------#
  # Create the window
  my $winAbout  = Win32::GUI::DialogBox->new(
    -name        => 'winAbout'                    ,
    -parent      => $win                          ,
    -text        => 'About XL-ParseMails'         ,
    -pos         => [$winPosX, $winPosY]          ,
    -size        => [520, 170]                    ,
    -background  => [255, 255, 255]               ,
    -hasmaximize => 0                             ,
    -hasminimize => 1                             ,
    -helpbutton  => 0                             ,
    -resizable   => 0                             ,
    -dialogui    => 1                             ,
  );
  $winAbout->SetIcon($$refIMG{ico});
  # About tab
  $winAbout->AddLabel(  -name        => 'lblLogo128'            ,
                        -size        => [128,128]               ,
                        -pos         => [  0,  0]               ,
                        -background  => [255, 255, 255]         ,
                        -bitmap      => $$refIMG{logo128}       , );
  $winAbout->AddLabel(  -name        => 'lblAbout1'             ,
                        -size        => [ 90, 75]               ,
                        -pos         => [140, 10]               ,
                        -font        => $font9                  ,
                        -background  => [255, 255, 255]         ,
                        -text        => "Version:\nWebsite:\nAuthor:", );
  $winAbout->AddLabel(  -name        => 'lblAbout2'             ,
                        -size        => [230, 75]               ,
                        -pos         => [235, 10]               ,
                        -font        => $font9b                 ,
                        -foreground  => [ 92, 172, 238]         ,
                        -background  => [255, 255, 255]         ,
                        -text        => "$VERSION\nhttp://www.le-tools.com\nAlain Rioux (admin\@le-tools.com)", );
  $winAbout->AddLabel(  -name        => 'lblAbout3'             ,
                        -size        => [300, 20]               ,
                        -pos         => [140, 80]               ,
                        -font        => $font9                  ,
                        -background  => [255, 255, 255]         ,
                        -text        => ' Copyright 2020 Alain Rioux', );
  $winAbout->Center($win);
  $winAbout->DoModal();
  return(1);
}  #--- End btnAbout_Click
#--------------------------#
sub winMain_Terminate { -1; }
#--------------------------#
#--------------------------#
sub lblNotReady_Click { &isProcessReady(1); }
#--------------------------#
#--------------------------#
sub isProcessReady {
#--------------------------#
  my $confirm = shift;
  return(0) if !$GUI{START};
  # Test input
  my $nextStep;
  $nextStep = 'You must select a valid dir as input.'      if !$win->tfInput->Text();
  $nextStep = 'You must select at least one input format.' if !$win->chInputMSG->Checked() and !$win->chInputEML->Checked() and !$nextStep;
  # Test functions
  if (!$win->TabFunctions->SelectedItem()) { # Parse headers tab
    if      ($win->rbPHTypical->Checked()) {
      my $nbrSelFields = 0;
      foreach (keys %{$FIELDS{PHT_SEL}}) { $nbrSelFields += $FIELDS{PHT_SEL}{$_}; }
      if (!$nbrSelFields) {
        $nextStep = 'You must choose at least one field for typical. See Settings.' if !$nextStep;
        $win->chPHAllReceived->Disable();
      } elsif (exists($FIELDS{PHT_SEL}{Received}) and $FIELDS{PHT_SEL}{Received} == 1) {
        $win->chPHAllReceived->Enable();
      } else { $win->chPHAllReceived->Disable(); }
    } elsif ($win->rbPHChoose->Checked()) {
      my $nbrSelFields = 0;
      foreach (keys %{$FIELDS{PH_SEL}}) { $nbrSelFields += $FIELDS{PH_SEL}{$_}; }
      if (!$nbrSelFields) {
        $nextStep = 'You must choose at least one field.' if !$nextStep;
        $win->chPHAllReceived->Disable();
      } elsif (exists($FIELDS{PH_SEL}{Received}) and $FIELDS{PH_SEL}{Received} == 1) {
        $win->chPHAllReceived->Enable();
      } else { $win->chPHAllReceived->Disable(); }
    } else { $win->chPHAllReceived->Enable(); }
    $nextStep = 'Max column width must be 10 or higher.'
    if !$SETTINGS{REPORT_FORMAT} and (!$SETTINGS{XLSX_MAX_WIDTH} or $SETTINGS{XLSX_MAX_WIDTH} < 10) and !$nextStep;
  } elsif ($win->TabFunctions->SelectedItem() == 1) { # Extract
    $nextStep = 'You must select at least one element to extract'
      if !$nextStep and ((!$win->chEHeaders->Checked()  and !$win->chEBody->Checked() and !$win->chEAttach->Checked()) or
                         (!$win->chEHeaders->Checked()  and  $win->chEBody->Checked() and !$win->chEAttach->Checked()  and
                          !$win->chEBodyText->Checked() and !$win->chEBodyHTML->Checked()));
    $nextStep = 'You must enter at least one file extension.'
      if !$nextStep and $win->chEAttach->Checked() and $win->rbEAttachExt->Checked() and !$win->tfEAttachExt->Text();
  } elsif ($win->TabFunctions->SelectedItem() == 2) { # Search
    $nextStep = 'You must select at least one element to search.'
      if !$nextStep and $win->rbSBody->Checked() and !$win->chSBodyText->Checked() and !$win->chSBodyHTML->Checked();
    $nextStep = 'You must enter a search term.' if !$nextStep and !$win->tfSTerms->Text();
    $nextStep = 'You must enter a valid regex.' if !$nextStep and $win->chSRegex->Checked() and !$win->lblSTermsOk->IsVisible;
  } elsif ($win->TabFunctions->SelectedItem() == 3) { # Gephi
    $nextStep = 'You must select at least one element.' if !$win->chGReceived->Checked and !$win->chGEmails->Checked;
  }
  $nextStep = 'You must select a folder for report.' if !$nextStep and !$win->tfDestDir->Text();  
  # Return an error message or enable the button
  if ($nextStep) {
    $win->btnProcess->Disable();
    $win->lblNotReady->Show();
    Win32::GUI::MessageBox($win, "Not ready?\n\nNext step: $nextStep", 'Not ready', 0x40040) if $confirm;
  } else {
    $win->btnProcess->Enable();
    $win->lblNotReady->Hide();
  }
}  #--- End isProcessReady
#--------------------------#
sub btnProcess_Click {
#--------------------------#
  # Avoid new thread
  if ($THR_PROCESS and $THR_PROCESS->is_running()) {
    Win32::GUI::MessageBox($win, 'A process is already running. Wait until it stops or restart the program.', 'Process running', 0x40010);
  } else {
    $THR_PROCESS = threads->create(sub {
      # Thread cancel signal handler
      $SIG{'KILL'} = sub {
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        threads->exit();
      };
      # Thread die signal handler
      $SIG{__DIE__} = sub {
        my $errMsg = $_[0];
        $errMsg    =~ s/[\t\r\n]/ /g;
        &logError("Process crash: $errMsg") if $SETTINGS{LOGGING};
        return if $_[0] and ($_[0]->isa('GeoIP2::Error::Generic') or $_[0]->isa('GeoIP2::Error::IPAddressNotFound') or
                             $_[0] =~ / is not a valid IPv4 or IPv6 address at /);
        $errMsg = (split(/ at /, $_[0]))[0];
        $win->lblPbCurr->Text('');
        $win->pb->SetPos(0);
        $win->lblPbCount->Text('');
        $win->lblPbCurr->Hide();
        $win->pb->Hide();
        $win->lblPbCount->Hide();
        $win->btnProcess->Show();
        $win->btnStop->Hide();
        $win->ChangeCursor($ARROW);
        Win32::GUI::MessageBox($win, "Error message: $errMsg", 'Error', 0x40010);
        threads->exit();
      };
      my $error = 0;
      my $inputDir = $win->tfInput->Text();
      # List files
      my (@files, @subFolders);
      if (opendir(DIR, "$inputDir\\")) {
        while (my $file = readdir(DIR)) {
          my $filePath = "$inputDir\\$file";
          if (-d $filePath and $file !~ /^\.\.?$/ and $file ne 'System Volume Information') {
            push(@subFolders, $filePath) if $win->chInputDirRecurse->Checked();
          } elsif (($file =~ /\.msg$/ and $win->chInputMSG->Checked()) or 
                   ($file =~ /\.eml$/ and $win->chInputEML->Checked())) {
            push(@files, encode('cp1252', $filePath));
          }
        }
        closedir(DIR);
      } else { &logError("Can't open $inputDir: $!") if $SETTINGS{LOGGING}; $error++; }
      # List folders and files in subfolders
      if ($win->chInputDirRecurse->Checked() and scalar(@subFolders) > 0) {
        foreach my $subFolder (@subFolders) {
          if (opendir(DIR,"$subFolder\\")) {
            while (my $file = readdir(DIR)) {
              my $filePath = "$subFolder\\$file";
              if (-d $filePath and $file !~ /^\.\.?$/ and $file ne 'System Volume Information') {
                push(@subFolders, $filePath) if $win->chInputDirRecurse->Checked();
              } elsif (($file =~ /\.msg$/ and $win->chInputMSG->Checked()) or
                       ($file =~ /\.eml$/ and $win->chInputEML->Checked())) {
                push(@files, encode('cp1252', $filePath));
              }
            }
            closedir(DIR);
          } else { &logError("Can't open $subFolder: $!") if $SETTINGS{LOGGING}; $error++; }
        }
      }
      # Function
      if (scalar(@files)) {
        if    (!$win->TabFunctions->SelectedItem()    ) { $error += &parseHeaders(\@files); }
        elsif ($win->TabFunctions->SelectedItem() == 1) { $error += &extract(     \@files); }
        elsif ($win->TabFunctions->SelectedItem() == 2) { $error += &search(      \@files); }
        elsif ($win->TabFunctions->SelectedItem() == 3) { $error += &gephi(       \@files); }
      }
      # Warn user about errors
      if ($error) {
        my $answer = Win32::GUI::MessageBox($win, 'There was at least one error, open the log file?', 'Error', 0x1014);
        $win->ShellExecute('open', $LOGGING_FILE,'','',1) if $answer == 6 and -e $LOGGING_FILE;
      }
    });
  }
}  #--- End btnProcess_Click
#--------------------------#
sub btnStop_Click {
#--------------------------#
  # Stop requests
  if ($THR_PROCESS and $THR_PROCESS->is_running()) { $THR_PROCESS->kill('KILL')->detach(); }
  return(1);
}  #--- End btnStop_Click
#--------------------------#
sub parseHeaders {
#--------------------------#
  my $refFiles = shift;
  my $error    = 0;
  my (@fields);
  push(@fields, 'File') if $win->chPHSourceFile->Checked();
  my (%fieldsList, %data);
  if ($win->rbPHTypical->Checked() or $win->rbPHChoose->Checked()) {
    if      ($win->rbPHTypical->Checked()) {
      foreach (keys %{$FIELDS{PHT_SEL}}) { push(@fields, $_) if $FIELDS{PHT_SEL}{$_}; }
    } elsif ($win->rbPHChoose->Checked() ) {
      foreach (keys %{$FIELDS{PH_SEL}} ) { push(@fields, $_) if $FIELDS{PH_SEL}{$_};  }
    }
    my $i = 0;
    foreach (@fields) { $fieldsList{uc($_)} = $i; $i++; }
    # Add fields
    if ($win->chPHNSLookup->Checked()  ) { $fieldsList{NSLOOKUP}    = $i; $i++; }
    if ($win->chPHISP->Checked()       ) { $fieldsList{ISP}         = $i; $i++; }
    if ($win->chPHGeoIP->Checked()     ) { $fieldsList{GEOIP}       = $i; $i++; }
    if ($win->chPHAttachList->Checked()) { $fieldsList{ATTACHMENTS} = $i; }
  } else { $fieldsList{FILE} = 0 if $win->chPHSourceFile->Checked(); }
  # Show progress
  my $i            = 0;
  my $nbrFiles     = scalar(@{$refFiles});
  $win->lblPbCount->Text("$i/$nbrFiles");
  $win->pb->SetRange(0, $nbrFiles);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text('Parsing email headers...');
  $win->lblPbCurr->Show();
  $win->pb->Show();
  $win->lblPbCount->Show();
  $win->btnProcess->Hide();
  $win->btnStop->Show();
  $win->ChangeCursor($HOURGLASS);
  # Extract data
  foreach my $file (@{$refFiles}) {
    my ($mime, $NSLookupStr, $ISPStr, $GeoIPStr, $attachmentStr);
    my @receivedFields;
    if ($file =~ /\.msg$/) {
      if (my $msg = new Email::Outlook::Message($file)) {
        $mime = $msg->to_email_mime;
      } else { &logError("Error opening $file: $!") if $SETTINGS{LOGGING}; $error++; next; }
    } else {
      if (open(my $fhEml, $file)) {
        local $/ = undef;
        my $msg  = <$fhEml>;
        close($fhEml);
        $mime = Email::MIME->new($msg);
      } else { &logError("Error opening $file: $!") if $SETTINGS{LOGGING}; $error++; next; }
    }
    if (!$mime) { &logError("Error parsing $file") if $SETTINGS{LOGGING}; $error++; next; }
    # Get attachment filenames
    $attachmentStr = &extractAttachmentName(\$mime) if $win->chPHAttachList->Checked();
    # Get all received fields values
    if ($win->chPHAllReceived->Checked() and exists($mime->{header}->{headers})) {
      my $nextRec = 0;
      foreach my $el (@{$mime->{header}->{headers}}) {
        if    ($nextRec         ) { push(@receivedFields, $el); $nextRec = 0; }
        elsif ($el eq 'Received') { $nextRec = 1; }
      }
    }
    my %head = $mime->header_str_pairs;
    my $j    = scalar(keys %fieldsList);
    foreach my $fieldName (keys %head) {
      if ((($win->rbPHTypical->Checked() or $win->rbPHChoose->Checked()) and exists($fieldsList{uc($fieldName)})) or
          ($win->rbPHChoose->Checked() and $fieldsList{'X-_FIELDS_'} and uc($fieldName) =~ /^X-/) or
          $win->rbPHAll->Checked()) {
        if (my $value = $head{$fieldName}) {
          if    ($win->rbPHAll->Checked()) { if (!exists($fieldsList{uc($fieldName)})) { $fieldsList{uc($fieldName)} = $j; $j++; } }
          elsif ($win->rbPHChoose->Checked() and $fieldsList{'X-_FIELDS_'} and uc($fieldName) =~ /^X-/) {
            if (!exists($fieldsList{uc($fieldName)})) { $fieldsList{uc($fieldName)} = $j; $j++; }
          }
          # Convert Datetime value in Date field
          if ($win->chPHDatetime->Checked() and uc($fieldName) eq 'DATE' and my $convertedDate = &convertDatetime($value)) {
            $value = $convertedDate;
          }
          # Remove tab from Received values
          if (uc($fieldName) eq 'RECEIVED') {
            if ($win->chPHAllReceived->Checked() and scalar(@receivedFields)) {
              my $newValue;
              my $k = scalar(@receivedFields);
              foreach my $received (@receivedFields) {
                my $recValue;
                if (ref($received) eq 'ARRAY') { $recValue .= $$received[0]; }
                else                           { $recValue  = $received;     }
                $recValue =~ s/[\t\s]/ /g;
                if ($win->chPHDatetime->Checked() and my $convertedDate = &convertDatetime($recValue)) {
                  $recValue = $convertedDate;
                }
                $newValue .= "$k - $recValue|";
                $k--;
              }
              chop($newValue);
              $value = $newValue;
            } else {
              $value =~ s/\t//g;
              if ($win->chPHDatetime->Checked() and my $convertedDate = &convertDatetime($value)) {
                $value = $convertedDate;
              }
            }
            # Resolve NSLookup/ISP/GeoIP details
            if ($win->chPHNSLookup->Checked() or $win->chPHISP->Checked() or $win->chPHGeoIP->Checked()) {
              my %IPs;
              my $copyValue = $value;
              # Extract IPv4
              while ($copyValue =~ /\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/) {
                my ($ip, $type) = &extractIP($copyValue);
                $IPs{$ip}{ver}  = 'IPv4' if !exists($IPs{$ip});
                $IPs{$ip}{type} = $type;
                my $longLigne   = length($copyValue);
                my $long        = length($ip);
                my $pos         = index($copyValue, $ip);
                my $offset      = $pos+$long;
                $copyValue      = substr($copyValue, $offset, $longLigne-$offset);
              }
              # Extract IPv6
              $copyValue = $value;
              while ($copyValue =~ /$IPv6_re/) {
                my ($ip, $type) = &extractIP($copyValue);
                $IPs{$ip}{ver}  = 'IPv6' if !exists($IPs{$ip});
                $IPs{$ip}{type} = $type;
                my $longLigne   = length($copyValue);
                my $long        = length($ip);
                my $pos         = index($copyValue, $ip);
                my $offset      = $pos+$long;
                $copyValue      = substr($copyValue, $offset, $longLigne-$offset);
              }
              if ($win->chPHNSLookup->Checked()) {
                foreach my $ip (keys %IPs) {
                  if ($IPs{$ip}{type} eq 'PUBLIC') {
                    $IPs{$ip}{nslookup} = &nsLookup($ip);
                    $IPs{$ip}{nslookup} = '?' if !$IPs{$ip}{nslookup};
                  } else { $IPs{$ip}{nslookup} = $IPs{$ip}{type}; }
                  $NSLookupStr .= "$ip = $IPs{$ip}{nslookup}\|";
                }
                chop($NSLookupStr) if $NSLookupStr;
              }
              if ($win->chPHISP->Checked()) {
                # Connect to XL-Whois database
                my $dsn = "DBI:SQLite:dbname=$SETTINGS{XLWHOIS_DB}";
                my $dbh = DBI->connect($dsn, undef, undef, { RaiseError => 1, AutoCommit => 1 });
                foreach my $ip (keys %IPs) {
                  if ($IPs{$ip}{type} eq 'PUBLIC') {
                    if ($IPs{$ip}{ver} eq 'IPv4') { $IPs{$ip}{ISP} = &checkIP_WhoisDB_IPv4($ip, \$dbh); }
                    else                          { $IPs{$ip}{ISP} = &checkIP_WhoisDB_IPv6($ip, \$dbh); }
                    $IPs{$ip}{ISP} = '?' if !$IPs{$ip}{ISP};
                  } else { $IPs{$ip}{ISP} = $IPs{$ip}{type}; }
                  $ISPStr .= "$ip = $IPs{$ip}{ISP}\|";
                }
                chop($ISPStr) if $ISPStr;
              }
              if ($win->chPHGeoIP->Checked()) {
                # Connect to GeoIP database
                if (my $reader = GeoIP2::Database::Reader->new(file => $SETTINGS{GEOIP_DB}, locales => ['en'])) {
                  foreach my $ip (keys %IPs) {
                    if ($IPs{$ip}{type} eq 'PUBLIC') {
                      $IPs{$ip}{GeoIP} = &resGeoIP($ip, \$reader);
                      $IPs{$ip}{GeoIP} = '?' if !$IPs{$ip}{GeoIP};
                    } else { $IPs{$ip}{GeoIP} = $IPs{$ip}{type}; }
                    $GeoIPStr .= "$ip = $IPs{$ip}{GeoIP}\|";
                  }
                  chop($GeoIPStr) if $GeoIPStr;
                }
              }
            }
          }
          $data{$file}{uc($fieldName)} = $value if $value;
        }
      }
    }
    $data{$file}{NSLOOKUP}    = $NSLookupStr   if $win->chPHNSLookup->Checked()   and $NSLookupStr;
    $data{$file}{ISP}         = $ISPStr        if $win->chPHISP->Checked()        and $ISPStr;
    $data{$file}{GEOIP}       = $GeoIPStr      if $win->chPHGeoIP->Checked()      and $GeoIPStr;
    $data{$file}{ATTACHMENTS} = $attachmentStr if $win->chPHAttachList->Checked() and $attachmentStr;
    # Progress
    $i++;
    $win->lblPbCount->Text("$i/$nbrFiles");
    $win->pb->StepIt();
  }
  delete($fieldsList{'X-_FIELDS_'}) if exists($fieldsList{'X-_FIELDS_'});
  if ($win->rbPHAll->Checked()) {
    my $i = scalar(keys %fieldsList);
    # Add fields
    if ($win->chPHNSLookup->Checked()  ) { $fieldsList{NSLOOKUP}    = $i; $i++; }
    if ($win->chPHISP->Checked()       ) { $fieldsList{ISP}         = $i; $i++; }
    if ($win->chPHGeoIP->Checked()     ) { $fieldsList{GEOIP}       = $i; $i++; }
    if ($win->chPHAttachList->Checked()) { $fieldsList{ATTACHMENTS} = $i; }
  }
  # Hide progress
  $win->lblPbCurr->Text('');
  $win->pb->SetPos(0);
  $win->lblPbCount->Text('');
  $win->pb->Hide();
  $win->lblPbCount->Hide();
  # Create report
  $win->lblPbCurr->Text('Creating report...');
  my $reportFilename = $SETTINGS{DEST_DIR} . "\\" . 'XL-ParseMails_report_';
  my $dateStr	= &date(time);
     $dateStr =~ s/:/-/g;
     $dateStr =~ s/ /_/g;
  my $fileExt = $win->cbReportFormat->GetString($win->cbReportFormat->GetCurSel());
  $reportFilename .= $dateStr . '.' . lc($fileExt);
  if    ($fileExt eq 'XLSX') { $error += &parseHeadersReportXLSX($reportFilename, \%data, \%fieldsList); }
  if    ($fileExt eq 'HTML') { $error += &parseHeadersReportHTML($reportFilename, \%data, \%fieldsList); }
  elsif ($fileExt eq 'CSV' ) { $error += &parseHeadersReportCSV( $reportFilename, \%data, \%fieldsList); }
  $win->lblPbCurr->Text('');
  $win->btnProcess->Show();
  $win->btnStop->Hide();
  $win->ChangeCursor($ARROW);
  # Open report
  $win->ShellExecute('open', $reportFilename,'','',1) if $SETTINGS{AUTO_OPEN_REPORT};
  return($error);
}  #--- End parseHeaders
#--------------------------#
sub parseHeadersReportXLSX {
#--------------------------#
  my ($reportFilename, $refData, $refFieldsList) = @_;
  if (my $excel = Excel::Writer::XLSX->new($reportFilename)) {
    # Set metadata
    $excel->set_properties(comments => 'Generated by XL-ParseEmails '.$VERSION);
    # Set formats
    my $formatHeader = $excel->add_format(size => 10, valign => 'vcenter', align => 'center', bold => 1);
    my $formatNormal = $excel->add_format(size => 10, valign => 'top');
    my $formatWrap   = $excel->add_format(size => 10, valign => 'top', text_wrap => 1);
    my $formatDate	 = $excel->add_format(size => 10, valign => 'top', num_format => 'yyyy-mm-dd hh:mm:ss');
    if (my $sheet = $excel->add_worksheet('Headers')) {
      my $col = 0;
      my @maxColWidth;
      # First line header
      foreach my $fieldName (sort { $$refFieldsList{$a} <=> $$refFieldsList{$b} } keys %{$refFieldsList}) {
        $sheet->write_string(0, $col, $fieldName, $formatHeader);
        push(@maxColWidth, length($fieldName)+4);
        $col++;
      }
      my $i = 1;
      foreach my $file (sort keys %{$refData}) {
        $col = 0;
        if ($win->chPHSourceFile->Checked()) { # Add the file column
          my $length = length($file);
          if ($length > $SETTINGS{XLSX_MAX_WIDTH}) {
            $length = $SETTINGS{XLSX_MAX_WIDTH};
            $sheet->write_string($i, $col, $file, $formatWrap);
          } else { $sheet->write_string($i, $col, $file, $formatNormal); }
          $maxColWidth[$col] = $length if ($length > $maxColWidth[$col]);
          $col++;
        }
        foreach my $fieldName (sort { $$refFieldsList{$a} <=> $$refFieldsList{$b} } keys %{$refFieldsList}) {
          if (my $value = $$refData{$file}{$fieldName}) {
            my $length = length($value);
            if ($length > $SETTINGS{XLSX_MAX_WIDTH}) {
              $length = $SETTINGS{XLSX_MAX_WIDTH};
              $value =~ s/\|/\r\n/g;
              $sheet->write_string($i, $col, $value, $formatWrap);
            } else {
              if ($value =~ /\|/) {
                $value =~ s/\|/\r\n/g;
                my @lines = split(/\r\n/, $value);
                $length = 10;
                foreach (@lines) { $length = length($_) if (length($_) > $length); }
                $sheet->write_string($i, $col, $value, $formatWrap);
              } else {
                $sheet->write_string($i, $col, $value, $formatNormal);
              }
            }
            $maxColWidth[$col] = $length if ($length > $maxColWidth[$col]);
          }
          $col++ if $fieldName ne 'FILE';
        }
        $i++;
      }
      $col = 0;
      foreach (@maxColWidth) { $sheet->set_column($col, $col, $_); $col++; }
      $sheet->autofilter(0, 0, 0, --$col);
      $sheet->freeze_panes(1, 0);
    }
    $excel->close();
    return(0);
  } else { &logError("Error creating $reportFilename: $!") if $SETTINGS{LOGGING}; return(1); }
}  #--- End parseHeadersReportXLSX
#--------------------------#
sub parseHeadersReportHTML {
#--------------------------#
  my ($reportFilename, $refData, $refFieldsList) = @_;
  if (open(my $fhReport, '>:encoding(UTF-8)', $reportFilename)) {
    flock($fhReport, 2);
		my $timeStr = &date(time);
    print $fhReport "<!DOCTYPE html>\n";
    print $fhReport "<html>\n<head>\n<title>XL-ParseMails report $timeStr</title>\n";
    print $fhReport "<meta name=\"generator\" content=\"XL-ParseMails $VERSION\">\n";
    print $fhReport "<meta charset=\"UTF-8\">\n";
    print $fhReport "<style>\n";
    print $fhReport "table, td { border-collapse: collapse; border: 1px solid black; padding: 5px; }\n";
    print $fhReport "td { font-size:11pt; vertical-align: top; white-space: wrap; }\n";
    print $fhReport ".header { text-align: center; font-weight: bold }\n";
    print $fhReport "</style>\n";
    print $fhReport "</head>\n";
    print $fhReport "<body style=\"font-family: Calibri, Verdana, Arial;\">\n";
    print $fhReport "<table align=\"center\" width=\"100%\">\n";
    print $fhReport "<tr>\n";
    foreach my $fieldName (sort { $$refFieldsList{$a} <=> $$refFieldsList{$b} } keys %{$refFieldsList}) {
      print $fhReport "<td class=\"header\">$fieldName</td>\n";
    }
    print $fhReport "</tr>\n";
    foreach my $file (sort keys %{$refData}) {
      print $fhReport "<tr>\n";
      print $fhReport "<td>$file</td>" if $win->chPHSourceFile->Checked();
      foreach my $fieldName (sort { $$refFieldsList{$a} <=> $$refFieldsList{$b} } keys %{$refFieldsList}) {
        if (my $value = $$refData{$file}{$fieldName}) {
          $value =~ s/</&lt;/g;
          $value =~ s/>/&gt;/g;
          $value =~ s/\|/<br>/g;
          print $fhReport "<td>$value</td>";
        } else { print $fhReport "<td>&nbsp;</td>" if $fieldName ne 'FILE'; }
      }
      print $fhReport "</tr>\n";
    }
		print $fhReport "</table>\n";
		print $fhReport "</body></html>\n";
    close($fhReport);
    return(0);
  } else { &logError("Error creating $reportFilename: $!") if $SETTINGS{LOGGING}; return(1); }
}  #--- End parseHeadersReportHTML
#--------------------------#
sub parseHeadersReportCSV {
#--------------------------#
  my ($reportFilename, $refData, $refFieldsList) = @_;
  my $separator = $win->cbCSVSepar->GetString($win->cbCSVSepar->GetCurSel());
  $separator    = "\t" if $separator eq 'Tab';
  if (open(my $fhReport, '>:encoding(UTF-8)', $reportFilename)) {
    my $line;
    foreach my $fieldName (sort { $$refFieldsList{$a} <=> $$refFieldsList{$b} } keys %{$refFieldsList}) {
      $line .= "$fieldName$separator";
    }
    chop($line);
    print $fhReport "$line\n";
    foreach my $file (sort keys %{$refData}) {
      my $line;
      $line .= "$file$separator" if $win->chPHSourceFile->Checked();
      foreach my $fieldName (sort { $$refFieldsList{$a} <=> $$refFieldsList{$b} } keys %{$refFieldsList}) {
        if (my $value = $$refData{$file}{$fieldName}) {
          $value = "\"$value\"" if $value =~ /$separator/;
          $line .= "$value$separator";
        } else { $line .= "$separator" if $fieldName ne 'FILE'; }
      }
      chop($line) if $line =~ /$separator$/;
      print $fhReport "$line\n";
    }
    close($fhReport);
    return(0);
  } else { &logError("Error creating $reportFilename: $!") if $SETTINGS{LOGGING}; return(1); }
}  #--- End parseHeadersReportCSV
#--------------------------#
sub extractAttachmentName {
#--------------------------#
  my $refMime = shift;
  my @attachments;
  my @parts = $$refMime->parts;
  foreach my $part (@parts) {
    my %partHeader = $part->header_str_pairs;
    if (!$part->subparts) {
      if ($partHeader{'Content-Transfer-Encoding'} eq 'base64') {
        if ($partHeader{'Content-Disposition'} =~ /attachment; filename="([^\"]+)"/) {
          push(@attachments, $1);
        }
      }
    }
  }
  return(join('|', @attachments));
}  #--- End extractAttachmentName
#--------------------------#
sub extract {
#--------------------------#
  my $refFiles = shift;
  my $error    = 0;
  my %fileExts;
  my %fieldsList;
  my %attached;
  # Fields for Extract Header
  if ($win->chEHeaders->Checked()) {
    my @fields;
    if ($win->rbETypical->Checked() or $win->rbEChoose->Checked()) {
      if      ($win->rbETypical->Checked()) {
        foreach (keys %{$FIELDS{ET_SEL}}) { push(@fields, $_) if $FIELDS{ET_SEL}{$_}; }
      } elsif ($win->rbEChoose->Checked() ) {
        foreach (keys %{$FIELDS{E_SEL}} ) { push(@fields, $_) if $FIELDS{E_SEL}{$_};  }
      }    
      my $i = 0;
      foreach (@fields) { $fieldsList{uc($_)} = $i; $i++; }
    }
  }  
  # Extract by extension
  if ($win->rbEAttachExt->Checked()) {
    my @exts = split(/, ?/, $win->tfEAttachExt->Text());
    foreach (@exts) { $_ =~ s/\.//g; $fileExts{$_} = 1 if !exists($fileExts{$_}); }
  }
  # Show progress
  my $i            = 0;
  my $nbrFiles     = scalar(@{$refFiles});
  $win->lblPbCount->Text("$i/$nbrFiles");
  $win->pb->SetRange(0, $nbrFiles);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text('Extracting email content...');
  $win->lblPbCurr->Show();
  $win->pb->Show();
  $win->lblPbCount->Show();
  $win->btnProcess->Hide();
  $win->btnStop->Show();
  $win->ChangeCursor($HOURGLASS);
  # Extract data
  foreach my $file (@{$refFiles}) {
    my ($mime);
    if ($file =~ /\.msg$/) {
      if (my $msg  = new Email::Outlook::Message($file)) {
        $mime = $msg->to_email_mime;
      } else { &logError("Error opening $file: $!") if $SETTINGS{LOGGING}; $error++; next; }
    } else {
      if (open(my $fhEml, $file)) {
        local $/ = undef;
        my $msg  = <$fhEml>;
        close($fhEml);
        $mime = Email::MIME->new($msg);
      } else { &logError("Error opening $file: $!") if $SETTINGS{LOGGING}; $error++; next; }
    }
    if (!$mime) { &logError("Error parsing $file") if $SETTINGS{LOGGING}; $error++; next; }
    # Prepare destination
    my $filename = (split(/\\/, $file))[-1]; # Gather filename from path
    if ($filename =~ /\./) { $filename =~ s/\.[^.]+$//; } # Remove extension
    my $destDir  = $SETTINGS{DEST_DIR};
       $destDir .= "\\" . $filename if $win->chEMsgFolder->Checked;
    my $encodedDir = encode('cp1252', $destDir);
    mkdir $encodedDir if !-d $encodedDir;
    my $extractBodyTxtFile  = $destDir . "\\" . $filename . '_extracted.txt';
    my $extractBodyHTMLFile = $destDir . "\\" . $filename . '_extracted.html';
    my $extractBodyHeaders  = $destDir . "\\" . $filename . '_headers.txt';
    # Extract Headers
    my $headerTxt;
    if ($win->chEHeaders->Checked() and exists($mime->{header}->{headers})) {
      my $record;
      my ($nextRec, $keep) = 0;
      foreach my $el (@{$mime->{header}->{headers}}) {
        if (ref($el) eq 'ARRAY') { $record  = $$el[1]; $nextRec = 0; } # Eml
        else {
          if ($nextRec) { $record .= "$el"; $nextRec = 0; }
          else {
            $record  = "$el: ";
            $nextRec = 1;
            $keep    = 1 if $win->rbEAll->Checked() or exists($fieldsList{uc($el)}) or
                            ($win->rbEChoose->Checked() and $fieldsList{'X-_FIELDS_'} and uc($el) =~ /^X-/);
          }
        }
        if (!$nextRec and $keep) { $headerTxt .= "$record\n"; $keep = 0; }
      }
      if (!$win->chEBodyMerge->Checked()) { # Print header in separated file
        if (open(my $fhHeader, '>:encoding(UTF-8)', encode('cp1252', $extractBodyHeaders))) {
          print $fhHeader "$headerTxt\n";
          close($fhHeader);
        } else { &logError("Error creating $extractBodyHeaders: $!") if $SETTINGS{LOGGING}; $error++; }
      }
    }
    my ($bodyText, $encTxt, $typeTxt, $bodyHTML, $encHTML, $typeHTML);
    my @parts    = $mime->parts;
    my $nbrParts = scalar(@parts);
    foreach my $part (@parts) {
      my %partHeader = $part->header_str_pairs;
      if ($nbrParts == 1 and my $body = $part->body_raw) {
        $bodyText .= $body if $win->chEBody->Checked() and $win->chEBodyText->Checked();
        $typeTxt  .= $mime->{ct}->{type} . "/" . $mime->{ct}->{subtype};
        $typeTxt  .= '; charset= ' . $mime->{ct}->{attributes}->{charset};
      } elsif ($part->subparts) {
        my @subParts = $part->parts;
        foreach my $subPart (@subParts) {
          if ($subPart->content_type =~ /multipart/) {
            my @subSubParts = $subPart->parts;
            foreach my $subSubPart (@subSubParts) {
              my %subSubPartHeader = $subSubPart->header_str_pairs;
              if ($subSubPartHeader{'Content-Transfer-Encoding'} eq '8bit' or
                  $subSubPart->content_type =~ /(?:text\/plain|quoted-printable|message\/)/) {
                $bodyText .= $subSubPart->body_raw if $win->chEBody->Checked() and $win->chEBodyText->Checked();
                $encTxt   .= $subSubPartHeader{'Content-Transfer-Encoding'};
                $typeTxt  .= $subSubPart->content_type;
              } elsif ($subSubPart->content_type =~ /text\/html/) {
                $bodyHTML .= $subSubPart->body_raw if $win->chEBody->Checked() and $win->chEBodyHTML->Checked();
                $encHTML  .= $subSubPartHeader{'Content-Transfer-Encoding'};
                $typeHTML .= $subSubPart->content_type;
              }
            }
          }
          my %subPartHeader = $subPart->header_str_pairs;
          if ($subPartHeader{'Content-Transfer-Encoding'} eq '8bit' or
              $subPart->content_type =~ /(?:text\/plain|quoted-printable|message\/)/) {
            $bodyText .= $subPart->body_raw if $win->chEBody->Checked() and $win->chEBodyText->Checked();
            $encTxt   .= $subPartHeader{'Content-Transfer-Encoding'};
            $typeTxt  .= $subPart->content_type;
          } elsif ($subPart->content_type =~ /text\/html/) {
            $bodyHTML .= $subPart->body_raw if $win->chEBody->Checked() and $win->chEBodyHTML->Checked();
            $encHTML  .= $subPartHeader{'Content-Transfer-Encoding'};
            $typeHTML .= $subPart->content_type;
          # Attachments
          } elsif ($subPartHeader{'Content-Transfer-Encoding'} eq 'base64' and $win->chEAttach->Checked()) {
            $error += &extractAttached(\%subPartHeader, \$subPart, \%attached, \%fileExts, $destDir, $filename);
          }
        }
      } else {
        # Attachments
        if ($partHeader{'Content-Transfer-Encoding'} eq 'base64' and $win->chEAttach->Checked()) {
          $error += &extractAttached(\%partHeader, \$part, \%attached, \%fileExts, $destDir, $filename);
        # SMTP errors (add to body text)
        } elsif ($partHeader{'Content-Type'} =~ /message\// and
                 $win->chEBody->Checked() and $win->chEBodyText->Checked()) {
          $bodyText .= "\n\nAttached message: $partHeader{'Content-Type'}\n\n";
          $bodyText .= $part->body_raw;
        }
      }
    }
    # Extract Body
    if ($bodyText) {
      my $fhTxt;
      if ($typeTxt =~ /(?:windows-1252|iso-)/) {
        if (!open($fhTxt, '>', encode('cp1252', $extractBodyTxtFile))) {
          &logError("Error creating $extractBodyTxtFile: $!") if $SETTINGS{LOGGING};
          $error++;
        }
      } else {
        if (!open($fhTxt, '>:encoding(UTF-8)', encode('cp1252', $extractBodyTxtFile))) {
          &logError("Error creating $extractBodyTxtFile: $!") if $SETTINGS{LOGGING};
          $error++;
        }
      }
      print $fhTxt "$headerTxt\n" if $win->chEBodyMerge->Checked() and $headerTxt; # Merge Header and Body
      if ($fhTxt) {
        $bodyText = decode_qp($bodyText) if $encTxt eq 'quoted-printable';
        $bodyText = decode('utf8', $bodyText) if $file =~ /\.eml$/ and $typeTxt =~ /utf-?8/i;
        if ($file =~ /\.msg$/) {
          $bodyText =~ s/\r/\n/g;
          $bodyText =~ s/[\n]+/\n/g;
        }
        print $fhTxt $bodyText;
        close($fhTxt);
      }
    }
    if ($bodyHTML) {
      my $fhHTML;
      if ($typeHTML =~ /(?:windows-1252|iso-)/) {
        if (!open($fhHTML, '>', encode('cp1252', $extractBodyHTMLFile))) {
          &logError("Error creating $extractBodyHTMLFile: $!") if $SETTINGS{LOGGING};
          $error++;
        }
      } else {
        if (!open($fhHTML, '>:encoding(UTF-8)', encode('cp1252', $extractBodyHTMLFile))) {
          &logError("Error creating $extractBodyHTMLFile: $!") if $SETTINGS{LOGGING};
          $error++;
        }
      }
      if ($fhHTML) {
        $bodyHTML = decode_qp($bodyHTML) if $encHTML eq 'quoted-printable';
        $bodyHTML = decode('utf8', $bodyHTML) if $file =~ /\.eml$/ and $typeHTML =~ /utf-?8/i;
        while ($bodyHTML =~ /src=\"cid:([^\"]+)/) {
          my $src = $1;
          if    (exists($attached{$src})) { $bodyHTML =~ s/src=\"cid:$src/src=\"$attached{$src}/g; }
          elsif ($src =~ /\@/)            { $bodyHTML =~ s/src=\"cid:([^\@]+)[^\"]+\"/src=\"$1\"/g; }
          else                            { $bodyHTML =~ s/src=\"cid:/src=\"/g; }
        }
        print $fhHTML $bodyHTML;
        close($fhHTML);
      }
    }
    # Progress
    $i++;
    $win->lblPbCount->Text("$i/$nbrFiles");
    $win->pb->StepIt();
  }
  # Hide progress
  $win->lblPbCurr->Text('');
  $win->pb->SetPos(0);
  $win->lblPbCount->Text('');
  $win->pb->Hide();
  $win->lblPbCount->Hide();
  $win->btnProcess->Show();
  $win->btnStop->Hide();
  $win->ChangeCursor($ARROW);
  # Open report
  Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $SETTINGS{DEST_DIR}", 0,
                         NORMAL_PRIORITY_CLASS, ".") if -d $SETTINGS{DEST_DIR} and $SETTINGS{AUTO_OPEN_REPORT};
  return($error);
}  #--- End extract
#--------------------------#
sub extractAttached {
#--------------------------#
  my ($refPartHeader, $refPart, $refAttached, $refFileExts, $destDir, $filename) = @_;
  if ($$refPartHeader{'Content-Type'} =~ /name="([^\"]+)"/) {
    my $attachFN = $1;
    my $fileExt  = (split(/\./, $attachFN))[-1];
    my $id       = $$refPartHeader{'Content-ID'};
    $id          =~ s/[\<\>]//g;
    $$refAttached{$id} = $attachFN if $id;
    # Extract Attachments
    if ($win->rbEAttachAll->Checked() or
       ($win->rbEAttachImg->Checked() and $$refPartHeader{'Content-Type'} =~ /image\//) or 
       ($win->rbEAttachExt->Checked() and exists($$refFileExts{$fileExt}))) {
      my $attachPath  = $destDir . "\\";
         $attachPath .= $filename . '_' if $win->chESource->Checked();
         $attachPath .= $attachFN;
      # If filename exists, rename it
      my $k = 1;
      while (-e $attachPath) {
        if ($attachPath =~ /(\.[^\.]+)$/) { # File with extension
          my $fileExt = $1;
          if ($attachPath =~ /_\((\d+)\)$fileExt/) { # A renamed file already exists ( _(digit) )
            $k = $1; $k++;
            $attachPath =~ s/_\(\d+\)$fileExt/_($k)$fileExt/;  # Ex.: _(1) becomes _(2)
          } else { $attachPath =~ s/$fileExt/_($k)$fileExt/; } # Add _(digit)
        } else { $attachPath .= "_($k)"; }
        $k++;
      }
      if (open(my $fhAttach, '>', encode('cp1252', $attachPath))) {
        binmode($fhAttach);
        my $base64 = $$refPart->body_raw;
           $base64 =~ s/\r/\n/g;
           $base64 =~ s/[\n]+/\n/g;
        print $fhAttach decode_base64($base64);
        close($fhAttach);
        return(0);
      } else { &logError("Error creating $attachPath: $!") if $SETTINGS{LOGGING}; return(1); }
    }
  }

}  #--- End extractAttached
#--------------------------#
sub search {
#--------------------------#
  my $refFiles = shift;
  my $error    = 0;
  my $reportFilename = $SETTINGS{DEST_DIR} . "\\" . 'XL-ParseMails_report_';
  my $dateStr	= &date(time);
     $dateStr =~ s/:/-/g;
     $dateStr =~ s/ /_/g;
  $reportFilename .= $dateStr . '.txt';
  my $nbrRes = 0;
  if (open(my $fhReport, '>:encoding(UTF-8)', $reportFilename)) {
    # Show progress
    my $i            = 0;
    my $nbrFiles     = scalar(@{$refFiles});
    $win->lblPbCount->Text("$i/$nbrFiles");
    $win->pb->SetRange(0, $nbrFiles);
    $win->pb->SetPos(0);
    $win->pb->SetStep(1);
    $win->lblPbCurr->Text('Searching in email...');
    $win->lblPbCurr->Show();
    $win->pb->Show();
    $win->lblPbCount->Show();
    $win->btnProcess->Hide();
    $win->btnStop->Show();
    $win->ChangeCursor($HOURGLASS);
    # Extract data
    foreach my $file (@{$refFiles}) {
      my ($mime);
      if ($file =~ /\.msg$/) {
        if (my $msg  = new Email::Outlook::Message($file)) {
          $mime = $msg->to_email_mime;
        } else { &logError("Error opening $file: $!") if $SETTINGS{LOGGING}; $error++; next; }
      } else {
        if (open(my $fhEml, $file)) {
          local $/ = undef;
          my $msg  = <$fhEml>;
          close($fhEml);
          $mime = Email::MIME->new($msg);
        } else { &logError("Error opening $file: $!") if $SETTINGS{LOGGING}; $error++; next; }
      }
      if (!$mime) { &logError("Error parsing $file") if $SETTINGS{LOGGING}; $error++; next; }
      my @lines;
      # Search Headers
      if ($win->rbSAll->Checked() or ($win->rbSHeader->Checked() and exists($mime->{header}->{headers}))) {
        my $record;
        my $nextRec = 0;
        foreach my $el (@{$mime->{header}->{headers}}) {
          if (ref($el) eq 'ARRAY') { $record = $$el[1]; $nextRec = 0; } # Eml
          else {
            if ($nextRec) { $record .= "$el"; $nextRec = 0; }
            else          { $record  = "$el: "; $nextRec = 1; }
          }
          push(@lines, $record);
        }
      }
      if ($win->rbSAll->Checked() or $win->rbSBody->Checked()) {
        # Search Body
        my ($bodyText, $encTxt, $typeTxt, $bodyHTML, $encHTML, $typeHTML);
        my @parts = $mime->parts;
        foreach my $part (@parts) {
          my %partHeader = $part->header_str_pairs;
          if ($part->subparts) {
            my @subParts = $part->parts;
            foreach my $subPart (@subParts) {
              if ($subPart->content_type =~ /multipart/) {
                my @subSubParts = $subPart->parts;
                foreach my $subSubPart (@subSubParts) {
                  my %subSubPartHeader = $subSubPart->header_str_pairs;
                  if ($subSubPartHeader{'Content-Transfer-Encoding'} eq '8bit' or
                      $subSubPart->content_type =~ /(?:text\/plain|quoted-printable)/) {
                    $bodyText = $subSubPart->body_raw if $win->chSBodyText->Checked();
                    $encTxt   = $subSubPartHeader{'Content-Transfer-Encoding'};
                    $typeTxt  = $subSubPart->content_type;
                  } elsif ($subSubPart->content_type =~ /text\/html/) {
                    $bodyHTML = $subSubPart->body_raw if $win->chSBodyHTML->Checked();
                    $encHTML  = $subSubPartHeader{'Content-Transfer-Encoding'};
                    $typeHTML = $subSubPart->content_type;
                  }
                }
              }
              my %subPartHeader = $subPart->header_str_pairs;
              if ($subPartHeader{'Content-Transfer-Encoding'} eq '8bit' or
                  $subPart->content_type =~ /(?:text\/plain|quoted-printable)/) {
                $bodyText = $subPart->body_raw if $win->chSBodyText->Checked();
                $encTxt   = $subPartHeader{'Content-Transfer-Encoding'};
                $typeTxt  = $subPart->content_type;
              } elsif ($subPart->content_type =~ /text\/html/) {
                $bodyHTML = $subPart->body_raw if $win->chSBodyHTML->Checked();
                $encHTML  = $subPartHeader{'Content-Transfer-Encoding'};
                $typeHTML = $subPart->content_type;
              }
            }
          } elsif ($partHeader{'Content-Type'} =~ /message\// and $win->chSBodyText->Checked()) {
            $bodyText .= "\n\nAttached message: $partHeader{'Content-Type'}\n\n";
            $bodyText .= $part->body_raw;
          }
        }
        my $content;
        if ($bodyText) {
          $bodyText = decode_qp($bodyText) if $encTxt eq 'quoted-printable';
          $bodyText = decode('utf8', $bodyText) if $file =~ /\.eml$/ and $typeTxt =~ /utf-?8/i;
          if ($file =~ /\.msg$/) {
            $bodyText =~ s/\r/\n/g;
            $bodyText =~ s/[\n]+/\n/g;
          }
          $content = $bodyText;
        }
        if ($bodyHTML) {
          $bodyHTML = decode_qp($bodyHTML) if $encHTML eq 'quoted-printable';
          $bodyHTML = decode('utf8', $bodyHTML) if $file =~ /\.eml$/ and $typeHTML =~ /utf-?8/i;
          $content .= $bodyHTML;
        }
        push(@lines, split(/\n/, $content));
      }
      # Search
      foreach my $line (@lines) {
        my $expr = $win->tfSTerms->Text();
        my @listRes;
        $expr = quotemeta($expr) if !$win->chSRegex->Checked();
        # Line match
        if (( $win->chSCase->Checked() and ($line =~ /$expr/ )) or
            (!$win->chSCase->Checked() and ($line =~ /$expr/i))) {
          # If there is at least one capture group, we must extract data
          my $r = Extract::Regex->new($expr, 1);
          if ($r->nbrCaptureGroups()) {
            while (( $win->chSCase->Checked() and ($line =~ /$expr/ )) or
                   (!$win->chSCase->Checked() and ($line =~ /$expr/i))) {
              my ($partRes, $pos, $width) = &extractExpr($line, $expr);
              if ($partRes) {
                print $fhReport $file . "\t" if $win->chSSource->Checked();
                print $fhReport "$partRes\n";
                $nbrRes++;
                # Remove processed part of the line
                chomp($partRes);
                my $lineWidth = length($line);
                my $offset    = $pos+$width;
                $line         = substr($line,$offset,$lineWidth-$offset);
              } else {
                if ($win->chSCase->Checked()) { $line =~ s/$expr//i; }
                else                          { $line =~ s/$expr//;  }
              }
            }
          } else { # No capture group, keep line
            print $fhReport $file . "\t" if $win->chSSource->Checked();
            print $fhReport "$line\n"; $nbrRes++;
          }
        }
      }
      # Progress
      $i++;
      $win->lblPbCount->Text("$i/$nbrFiles");
      $win->pb->StepIt();
    }
    close($fhReport);
  } else { &logError("Error creating $reportFilename: $!") if $SETTINGS{LOGGING}; $error++; }
  unlink($reportFilename) if !$nbrRes and -e $reportFilename;
  # Hide progress
  $win->lblPbCurr->Text('');
  $win->pb->SetPos(0);
  $win->lblPbCount->Text('');
  $win->pb->Hide();
  $win->lblPbCount->Hide();
  $win->btnProcess->Show();
  $win->btnStop->Hide();
  $win->ChangeCursor($ARROW);
  # Open report
  $win->ShellExecute('open', $reportFilename,'','',1) if $SETTINGS{AUTO_OPEN_REPORT} and -e $reportFilename;
  return($error);
}  #--- End search
#------------------------------------------------------------------------------#
sub extractExpr {
#------------------------------------------------------------------------------#
  my ($line, $expr) = @_;
  my ($width, $pos) = 0;
  my @listRes;
  my $res;
  # Test expr again
  if ($win->chSCase->Checked())  { @listRes = ($line =~ /$expr/);  }
  else                           { @listRes = ($line =~ /$expr/i); }
  foreach (@listRes) {
    if (defined $_) {
      $res  .= "$_\t";
      $pos   = index($line,$_,$pos);
      $width = length($_);
    }
  }
  chop($res);
  return($res, $pos, $width);
}  #--- End extractExpr
#--------------------------#
sub validRegex {
#--------------------------#
  my $regex = shift;
  if ($regex) {
    eval { if ('test' =~ /$regex/) { } };
    if ($@) {
      my $errRegex = (split(/ at /,$@))[0];
      return(1, $errRegex);
    } else {
      # Valid but senseless regex
      return(2, undef) if $regex =~ /^\||\|\||(?:[^\\]\|$)/ or $regex =~ /^\(\.\*\)$/;
      return(0, undef);
    }
  }  
}  #--- End validRegex
#--------------------------#
sub gephi {
#--------------------------#
  my $refFiles = shift;
  my $error    = 0;
  my (%received, %email, %receivedLnk, %emailLnk, %mergeLnk);
  # Show progress
  my $i            = 0;
  my $nbrFiles     = scalar(@{$refFiles});
  $win->lblPbCount->Text("$i/$nbrFiles");
  $win->pb->SetRange(0, $nbrFiles);
  $win->pb->SetPos(0);
  $win->pb->SetStep(1);
  $win->lblPbCurr->Text('Parsing email headers...');
  $win->lblPbCurr->Show();
  $win->pb->Show();
  $win->lblPbCount->Show();
  $win->btnProcess->Hide();
  $win->btnStop->Show();
  $win->ChangeCursor($HOURGLASS);
  # Extract data
  foreach my $file (@{$refFiles}) {
    my $mime;
    if ($file =~ /\.msg$/) {
      if (my $msg  = new Email::Outlook::Message($file)) {
        $mime = $msg->to_email_mime;
      } else { &logError("Error opening $file: $!") if $SETTINGS{LOGGING}; $error++; next; }
    } else {
      if (open(my $fhEml, $file)) {
        local $/ = undef;
        my $msg  = <$fhEml>;
        close($fhEml);
        $mime = Email::MIME->new($msg);
      } else { &logError("Error opening $file: $!") if $SETTINGS{LOGGING}; $error++; next; }
    }
    if (!$mime) { &logError("Error parsing $file") if $SETTINGS{LOGGING}; $error++; next; }
    # Get all received fields values
    my ($firstRecvFrom, $firstRecvBy, $lastRecvFrom, $lastRecvBy);
    if ($win->chGReceived->Checked() and exists($mime->{header}->{headers})) {
      my $nextRec = 0;
      my @receivedF;
      foreach my $el (@{$mime->{header}->{headers}}) {
        if    ($nextRec         ) { push(@receivedF, $el); $nextRec = 0; }
        elsif ($el eq 'Received') { $nextRec = 1; }
      }
      foreach my $recv (reverse @receivedF) {
        my ($value, $from, $fromHost, $fromIP, $fromIPType, $by, $byHost, $byIP, $byIPType);
        if (ref($recv) eq 'ARRAY') { $value .= $$recv[0]; }
        else                       { $value  = $recv;     }
        if ($value =~ /from ([^ ]+) (.+?)by/) {
          $fromHost = $1;
          $from     = $fromHost;
          ($fromIP, $fromIPType) = &extractIP($2);
          ($fromIP, $fromIPType) = &extractIP($1) if !$fromIP;
          chop($fromIP) while $fromIP =~ s/\s$//;
          $from .= ' ' . $fromIP if $fromIP;
        } elsif ($value =~ /from ([^ ]+) by/) { $from = $1; }
        $fromIPType = 'UNKNOWN' if !$fromIPType;
        if ($value =~ /by ([^ ]+) ([^ ]+)/  ) {
          $byHost = $1;
          $by     = $byHost;
          ($byIP, $byIPType) = &extractIP($2);
          ($byIP, $byIPType) = &extractIP($1) if !$byIP;
          $by .= ' ' . $byIP if $byIP;
        }
        $byIPType = 'UNKNOWN' if !$byIPType;        
        # Node
        if (!$win->rbGRecvBoth->Checked()) { # IPs or hostnames
          if ($win->rbGRecvBoth->Checked()  ) {  # IPs only
            $from = $fromIP if $fromIP;
            $by   = $byIP   if $byIP;
          } else {
            $from = $fromHost; $by = $byHost; } # Host only
        }
        if ($from and !exists($received{$from}) and !$win->rbGRecvBy->Checked()) {
          $received{$from}{id}   = 'R'.(scalar(keys %received)+1);
          $received{$from}{type} = $fromIPType;
        }
        if ($by and !exists($received{$by}) and !$win->rbGRecvFrom->Checked()) {
          $received{$by}{id}   = 'R'.(scalar(keys %received)+1);
          $received{$by}{type} = $byIPType;
        }
        # Edge
        if ($win->rbGRecvFB->Checked()) { # Link between From and By
          if ($from) {
            if (exists($receivedLnk{"$received{$from}{id}\t$received{$by}{id}"})) {
              $receivedLnk{"$received{$from}{id}\t$received{$by}{id}"}++;
            } else { $receivedLnk{"$received{$from}{id}\t$received{$by}{id}"} = 1; }
          }
          if ($lastRecvBy) { # Link with last received
            if ($from) {
              if (exists($receivedLnk{"$lastRecvBy\t$received{$from}{id}"})) {
                $receivedLnk{"$lastRecvBy\t$received{$from}{id}"}++;
              } else { $receivedLnk{"$lastRecvBy\t$received{$from}{id}"} = 1; }
            } else {
              if (exists($receivedLnk{"$lastRecvBy\t$received{$by}{id}"})) {
                $receivedLnk{"$lastRecvBy\t$received{$by}{id}"}++;
              } else { $receivedLnk{"$lastRecvBy\t$received{$by}{id}"} = 1; }              
            }
          }
          if ($by) {
            $firstRecvBy   = $received{$by}{id} if !$firstRecvBy;
            $lastRecvBy    = $received{$by}{id};
          }
          if ($from) {
            $firstRecvFrom = $received{$from}{id} if !$firstRecvFrom;
            $lastRecvFrom  = $received{$from}{id};
          }
        } elsif ($win->rbGRecvFrom->Checked()) { # Link between last From and this From
          if ($lastRecvFrom and $from) {
            if (exists($receivedLnk{"$lastRecvFrom\t$received{$from}{id}"})) {
              $receivedLnk{"$lastRecvFrom\t$received{$from}{id}"}++;
            } else { $receivedLnk{"$lastRecvFrom\t$received{$from}{id}"} = 1; }
          }
          if ($from) {
            $firstRecvFrom = $received{$from}{id} if !$firstRecvFrom;
            $lastRecvFrom  = $received{$from}{id};
          }
        } else { # Link between last By and this By
          if ($lastRecvBy) {
            if (exists($receivedLnk{"$lastRecvBy\t$received{$by}{id}"})) {
              $receivedLnk{"$lastRecvBy\t$received{$by}{id}"}++;
            } else { $receivedLnk{"$lastRecvBy\t$received{$by}{id}"} = 1; }
          }
          if ($by) {
            $firstRecvBy = $received{$by}{id} if !$firstRecvBy;
            $lastRecvBy  = $received{$by}{id};
          }
        }
      }
    }
    # Get all email addresses
    if ($win->chGEmails->Checked() and my %head = $mime->header_str_pairs) {
      my ($from, $to);
      foreach my $fieldName (keys %head) {
        if (my $value = $head{$fieldName}) {
          $from = $value if uc($fieldName) eq 'FROM';
          $to   = $value if uc($fieldName) eq 'TO';
        }
      }
      if ($from and $to) {
        my @receivers = split(/, ?/, $to); # List receivers
        # Node
        if (!$win->rbGEmailBoth->Checked()) {
          my ($fromName, $fromAddr) = split(/ </, $from);
          if ($win->rbGEmailName->Checked()) { $from = $fromName; }
          else {
            $fromAddr =~ s/>//;
            $fromAddr = $fromName if !$fromAddr;
            $from     = $fromAddr;
          }
          foreach my $i (0 .. (scalar(@receivers)-1)) {
            my ($toName  , $toAddr  ) = split(/ </, $receivers[$i]);
            if ($win->rbGEmailName->Checked()) { $receivers[$i] = $toName; }
            else {
              $toAddr =~ s/>//;
              if ($toAddr) { $receivers[$i] = $toAddr; }
              else         { $receivers[$i] = $toName; }
            }
          }
        }
        $email{$from} = scalar(keys %email)+1 if !exists($email{$from});
        if ($win->chGReceived->Checked()) { # Sender email to first received
          my $serv = $firstRecvFrom;
          $serv    = $firstRecvBy if !$serv;
          if (exists($mergeLnk{"$email{$from}\t$serv"})) {
            $mergeLnk{"$email{$from}\t$serv"}++;
          } else { $mergeLnk{"$email{$from}\t$serv"} = 1; }
        }
        foreach my $recv (@receivers) {
          $email{$recv}   = scalar(keys %email)+1 if !exists($email{$recv}  );
          # Edge
          if (exists($emailLnk{"$email{$from}\t$email{$recv}"})) {
            $emailLnk{"$email{$from}\t$email{$recv}"}++;
          } else { $emailLnk{"$email{$from}\t$email{$recv}"} = 1; }
          # Merge (link between email and received)
          if ($win->chGReceived->Checked()) { # Last received to receiver email
            my $serv = $lastRecvBy;
            $serv    = $lastRecvFrom if !$serv;
            if ($lastRecvBy and exists($mergeLnk{"$serv\t$email{$recv}"})) {
              $mergeLnk{"$serv\t$email{$recv}"}++;
            } else { $mergeLnk{"$serv\t$email{$recv}"} = 1; }
          }
        }
      }
    }
    # Progress
    $i++;
    $win->lblPbCount->Text("$i/$nbrFiles");
    $win->pb->StepIt();
  }
  # Hide progress
  $win->lblPbCurr->Text('');
  $win->pb->SetPos(0);
  $win->lblPbCount->Text('');
  $win->pb->Hide();
  $win->lblPbCount->Hide();
  # Create report
  $win->lblPbCurr->Text('Creating csv files...');
  # Received CSV
  if ($win->chGReceived->Checked() and scalar(keys %received) and scalar(keys %receivedLnk)) {
    my $nodeCSVFN = $SETTINGS{DEST_DIR} . "\\" . 'Received_Node.csv';
    if (open(NODE, ">:encoding(UTF-8)", $nodeCSVFN)) {
      print NODE "Id\tLabel\tCategory\tRegion\n";
      foreach my $serv (sort { $received{$a}{id} cmp $received{$b}{id} } keys %received) {
        print NODE "$received{$serv}{id}\t$serv\tReceived\t$received{$serv}{type}\n";
      }
      # Add emails
      if ($win->chGEmails->Checked() and scalar(keys %email) and scalar(keys %mergeLnk)) {
        foreach my $value (sort { $email{$a} <=> $email{$b} } keys %email) { print NODE "$email{$value}\t$value\tEmail\tEMAIL\n"; }
      }
      close(NODE);
    } else { &logError("Error creating $nodeCSVFN: $!") if $SETTINGS{LOGGING}; $error++; }
    my $edgeCSVFN = $SETTINGS{DEST_DIR} . "\\" . 'Received_Edge.csv';
    if (open(EDGE, ">:encoding(UTF-8)", $edgeCSVFN)) {
      print EDGE "Source\tTarget\tType\tWeight\n";
      foreach my $lnk (sort sortLNK(keys %receivedLnk) ) { print EDGE "$lnk\tdirected\t$receivedLnk{$lnk}\n"; }
      if ($win->chGEmails->Checked() and scalar(keys %email) and scalar(keys %mergeLnk)) {
        foreach my $lnk (keys %mergeLnk) { print EDGE "$lnk\tdirected\t1\n"; }
      }
      close(EDGE);
    } else { &logError("Error creating $edgeCSVFN: $!") if $SETTINGS{LOGGING}; $error++; }
  }
  # Emails CSV
  elsif ($win->chGEmails->Checked() and scalar(keys %email) and scalar(keys %emailLnk)) {
    my $nodeCSVFN = $SETTINGS{DEST_DIR} . "\\" . 'Emails_Node.csv';
    if (open(NODE, ">:encoding(UTF-8)", $nodeCSVFN)) {
      print NODE "Id\tLabel\tCategory\tRegion\n";
      foreach my $value (sort { $email{$a} <=> $email{$b} } keys %email) { print NODE "$email{$value}\t$value\tReceived\tcold\n"; }
      close(NODE);
    } else { &logError("Error creating $nodeCSVFN: $!") if $SETTINGS{LOGGING}; $error++; }
    my $edgeCSVFN = $SETTINGS{DEST_DIR} . "\\" . 'Emails_Edge.csv';
    if (open(EDGE, ">:encoding(UTF-8)", $edgeCSVFN)) {
      print EDGE "Source\tTarget\tType\tWeight\n";
      foreach my $lnk (sort sortLNK(keys %emailLnk) ) { print EDGE "$lnk\tdirected\t1\n"; }
      close(EDGE);
    } else { &logError("Error creating $edgeCSVFN: $!") if $SETTINGS{LOGGING}; $error++; }
  }
  $win->btnProcess->Show();
  $win->btnStop->Hide();
  $win->ChangeCursor($ARROW);
  # Open directory in Window Explorer
  Win32::Process::Create(my $ProcessObj, "$ENV{'WINDIR'}\\explorer.exe", "explorer $SETTINGS{DEST_DIR}", 0,
                         NORMAL_PRIORITY_CLASS, ".") if -d $SETTINGS{DEST_DIR} and $SETTINGS{AUTO_OPEN_REPORT};
  return($error);
}  #--- End gephi
#--------------------------#
sub extractIP {
#--------------------------#
  my $str = shift;
  if ($str =~ /(?:[^0-9]|^)((?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?))(?:[^0-9\.]|$)/ or
      $str =~ /($IPv6_re)/) {
    my $ip = $1;
    my $type;
    if (my $netIp = new Net::IP ($ip)) { $type = $netIp->iptype(); }
    if ($type eq '6TO4') {
      if ($ip =~ /2002:([^:]+):([^:]+)/ and $SETTINGS{'6TO4'}) {
        my $ipv4dec =  hex(sprintf("%04s", $1) . sprintf("%04s", $2));
        $ip = join '.', unpack 'C4', pack 'N', $ipv4dec;
        if (my $netIp = new Net::IP ($ip)) { $type = $netIp->iptype(); }
      }
    }
    $type = 'UNKNOWN' if !$type;
    return($ip, $type);
  }
  return(undef, 'UNKNOWN');
  
}  #--- End extractIP
#--------------------------#
sub sortLNK {
#--------------------------#
  my ($a1,$a2) = split(/\t/, $a);
  my ($b1,$b2) = split(/\t/, $b);
  if ($a1 == $b1) { return($a2 <=> $b2); }
  else            { return($a1 <=> $b1); }
}  #--- End sortLNK
#--------------------------#
sub validSQLiteDB {
#--------------------------#
  my ($DBFile, $table) = @_;
  if (-f $DBFile) {
    my $dsn = "DBI:SQLite:dbname=$DBFile";
    if (my $dbh = DBI->connect($dsn, undef, undef, { })) {
      if (my $sth = $dbh->table_info(undef, undef, '%', 'TABLE')) {
				my @info = $sth->fetchrow_array;
				$sth->finish();
				return(1) if $info[2] eq $table; # If table exists, database is valid
			}
    }
  }
  return(0);
}  #--- End validSQLiteDB
#--------------------------#
sub validGeoIPDB {
#--------------------------#
  my $GeoIPDBFile = shift;
  if (-e $GeoIPDBFile) {
		eval { MaxMind::DB::Reader->new(file => $GeoIPDBFile) };
    if (!$@) { return(1); }
		else		 { return(0); }
  } else { return(0); }
}  #--- End validGeoIPDB
#--------------------------#
sub convertDatetime {
#--------------------------#
  my $string = shift;
  my %formats = (
    'Tuesday, 08-Feb-1994 14:15:29 GMT' => '\d+, \d{2}\-\w{3}\-\d{4} \d{2}\:\d{2}\:\d{2} \w{3}',
    'Thu Feb  3 17:03:55 GMT 1994' => '\w{3} \w{3} + \d{1,2} \d{2}\:\d{2}\:\d{2} \w{3} \d{4}',
    'Wed, 09 Feb 1994 22:23:32 +0000 (GMT)' => '\w{3}, \d{1,2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} [-+]?\d{4} \(\w{3}\)',
    'Tuesday, 08-Feb-94 14:15:29 GMT' => '\d+, \d{2}\-\w{3}\-\d{2} \d{2}\:\d{2}\:\d{2} \w{3}',
    'Wed, 09 Feb 1994 22:23:32 +0000' => '\w{3}, \d{1,2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} [-+]?\d{4}',
    'Wed, 09 Feb 1994 22:23:32 GMT' => '\w{3}, \d{1,2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} \w{3}',
    '03/Feb/1994:17:03:55 -0700' => '\d{2}\/\w{3}\/\d{4}\:\d{2}\:\d{2}\:\d{2} [\-\+]?\d{4}',
    '1994-02-03 14:15:29 -0100' => '\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2} [\-\+]?\d{4}',
    '08-Feb-1994 14:15:29 GMT' => '\d{2}\-\w{3}\-\d{4} \d{2}\:\d{2}\:\d{2} \w{3}',
    '09 Feb 1994 22:23:32 GMT' => '\d{2} \w{3} \d{4} \d{2}\:\d{2}\:\d{2} \w{3}',
    '08-Feb-94 14:15:29 GMT' => '\d{2}\-\w{3}\-\d{2} \d{2}\:\d{2}\:\d{2} \w{3}',
    'Thu Feb  3 00:00:00 1994' => '\w{3} \w{3} + \d{1,2} \d{2}\:\d{2}\:\d{2}',
    '1994-02-03 14:15:29' => '\d{4}\-\d{2}\-\d{2} \d{2}\:\d{2}\:\d{2}',
    '03/02/1994 14:15:29' => '\d{2}\/\d{2}\/\d{4} \d{2}\:\d{2}\:\d{2}',
    '1994-02-03T14:15:29' => '\d{4}\-\d{2}\-\d{2}T\d{2}\:\d{2}\:\d{2}',
    '11-15-96  03:52PM' => '\d{2}\-\d{2}\-\d{2} +\d{2}\:\d{2}\w{2}',
    'Feb  3 17:03' => '\w{3} +\d{1,2} +\d{2}\:\d{2}',
    'Feb  3  1994' => '\w{3} +\d{1,2} +\d{4}',
    '08-Feb-1994' => '\d{2}\-\w{3}\-\d{4}',
    '03/Feb/1994' => '\d{2}\/\w{3}\/\d{4}',
    '1994-02-03' => '\d{4}\-\d{2}\-\d{2}',
    '19940203T141529Z' => '\d{8}T\d{6}Z',
    '08-Feb-94' => '\d{2}\-\w{3}\-\d{2}',
    '09 Feb 1994' => '\d{2} \w{3} \d{4}',
    '19940203' => '\d{8}'
  );
  # Guess format
  my $time;
  foreach my $format (keys %formats) {
    my $regex = $formats{$format};
    if ($string =~ /($regex)/) {
      my $dateStr = $1;
      eval { $time = str2time($dateStr); };
      if (!$@ and $time) {
        my $dt = DateTime->from_epoch(epoch => $time);
        $dt->set_time_zone($winSettings->cbLocalTZ->GetString($SETTINGS{LOCAL_TIMEZONE}));
        my $newDateStr = $dt->strftime('%F %T %z');
        my $replace = quotemeta($dateStr);
        $string =~ s/$replace/$newDateStr/;
        return($string);
      }
    }
  }
  return($string);
}  #--- End convertDatetime
#--------------------------#
sub nsLookup {
#--------------------------#
  my $ip  = shift;
  my $res = Net::DNS::Resolver->new;
  $res->tcp_timeout(5);
  $res->udp_timeout(5);
  my $packet = $res->query($ip, "PTR", "IN");
  if ($packet) {
    my @addrs    = $packet->answer;
    my $hostname = '';
    foreach (@addrs) { $hostname .= $_->ptrdname.", " if $_->type eq 'PTR' and $_->ptrdname; }
    if ($hostname) {
      chop($hostname); chop($hostname);
      return($hostname);
    }
  }
  return('No result');
}  #--- End nsLookup
#--------------------------#
sub checkIP_WhoisDB_IPv4 {
#--------------------------#
  my ($ip, $refDbh) = @_;
  my $ipInt = unpack 'N', pack 'C4', split '\.', $ip;
  my ($isp, $country);
  my $interMin = 4294967295;
  my $sth = $$refDbh->prepare("SELECT range_s,range_e,isp,country from WHOIS_DB WHERE $ipInt >= range_s AND $ipInt <= range_e");
  my $rv  = $sth->execute();
  if ($rv > -1) {
    # Choose smaller range 
    my $refAllRows = $sth->fetchall_arrayref();
    foreach my $refRow (@{$refAllRows}) {
      my $inter = $$refRow[1] - $$refRow[0];
      if ($inter < $interMin) {
        $interMin = $inter;
        $isp      = $$refRow[2];
        $country  = $$refRow[3];
      }
    }
  }
  if ($isp and $country) { return("$isp, $country"); }
  else                   { return(undef);            }
}  #--- End checkIP_WhoisDB_IPv4
#--------------------------#
sub checkIP_WhoisDB_IPv6 {
#--------------------------#
  my ($ip, $refDbh) = @_;
  my $all = $$refDbh->selectall_arrayref("SELECT * FROM WHOIS_DB_6");
  foreach my $row (@$all) {
    my $cidr = @$row[0];
    return("@$row[1], @$row[2]") if Net::CIDR::cidrlookup($ip, ($cidr));
  }
}  #--- End checkIP_WhoisDB_IPv6
#--------------------------#
sub resGeoIP {
#--------------------------#
  my ($ip, $refReader) = @_;
  my $record;
  eval { $record = $$refReader->city(ip => $ip); };
  if ($record) {
    my $answer;
    $answer .= $record->city()->name().','										if $record->city()->name();
    $answer .= $record->most_specific_subdivision->name().','	if $record->most_specific_subdivision->name();
    $answer .= $record->country()->name().','									if $record->country()->name();
    chop($answer);
    return($answer);
  }
  return(undef);
}  #--- Fin resGeoIP
#--------------------------#
sub date {
#--------------------------#
  my $time = shift;
	if ($time) {
		my ($s,$min,$hr,$d,$m,$y) = localtime($time);
		return(sprintf("%04d\-%02d\-%02d %02d:%02d:%02d", $y+1900, $m+1, $d, $hr, $min, $s));
	}
}  #--- End date
#--------------------------#
sub logError {
#--------------------------#
  my $refMsg = shift;
  my $dateStr = &date(time);
  # Save error msg in log file
	my $fhLog;
  if (-e $LOGGING_FILE) { open($fhLog,">>$LOGGING_FILE"); }
  else                  { open($fhLog,">$LOGGING_FILE");  }
  flock($fhLog, 2);
  print $fhLog "$dateStr\t$refMsg\n";
  close($fhLog);  
}  #--- End log
#--------------------------#
sub saveSettings {
#--------------------------#
  $SETTINGS{PHT_SEL} = '';
  $SETTINGS{ET_SEL}  = '';
  foreach (keys %{$FIELDS{PHT_SEL}}) { $SETTINGS{PHT_SEL} .= $_ . ' ' if $FIELDS{PHT_SEL}{$_} == 1; }
  foreach (keys %{$FIELDS{ET_SEL}} ) { $SETTINGS{ET_SEL}  .= $_ . ' ' if $FIELDS{ET_SEL}{$_}  == 1; }
  chop($SETTINGS{PHT_SEL});
  chop($SETTINGS{ET_SEL});
  open(FH_SETTINGS,">$SETTINGS_FILE");
  flock(FH_SETTINGS, 2);
  foreach my $cle (keys %SETTINGS) { print FH_SETTINGS "$cle = $SETTINGS{$cle}\n"; }
  close(FH_SETTINGS);  
}  #--- End saveSettings
#--------------------------#
sub loadSettings {
#--------------------------#
  # Open and load settings values
  if (-e $SETTINGS_FILE) {
    open(FH_SETTINGS, $SETTINGS_FILE);
    my @tab = <FH_SETTINGS>;
    close(FH_SETTINGS);
    foreach (@tab) {
      chomp($_);
      my ($key, $value) = split(/ = /, $_);
      $SETTINGS{$key}   = $value if $key;
    }
  } else { # Create one
    open(FH_SETTINGS, ">$SETTINGS_FILE");
    close(FH_SETTINGS);
  }
  # General tab
  if (exists($SETTINGS{TOOL_AUTO_UPDATE})) { $winSettings->chAutoUpdate->Checked($SETTINGS{TOOL_AUTO_UPDATE});        }
  else                                     { $winSettings->chAutoUpdate->Checked(1); $SETTINGS{TOOL_AUTO_UPDATE} = 1; } # Default is checked
  if (exists($SETTINGS{LOGGING})         ) { $winSettings->chLogging->Checked($SETTINGS{LOGGING});                    }
  else                                     { $winSettings->chLogging->Checked(1); $SETTINGS{LOGGING} = 1;             } # Default is checked
  if (exists($SETTINGS{LOCAL_TIMEZONE}))   { $winSettings->cbLocalTZ->SetCurSel($SETTINGS{LOCAL_TIMEZONE});           }
  else { # Try to find local timezone, if not found, set to America/New York
    my $index = 107;
    my $localTZ;
    eval { $localTZ = DateTime::TimeZone->new(name => 'local'); };
    $index = $winSettings->cbLocalTZ->FindStringExact($localTZ->{name}) if !$@;
    $winSettings->cbLocalTZ->SetCurSel($index);
    $SETTINGS{LOCAL_TIMEZONE} = $index;
  }
  # Set the field list
  my @fieldList = qw/From To Date Subject X-ORIGINATING-IP Received Accept-Language Content-Language Content-Transfer-Encoding Content-Type DKIM-Signature In-Reply-To MIME-Version Message-Id References Reply-To Thread-Index Thread-Topic Received-spf X-_Fields_/;
  my @defList1  = qw/From To Date Subject X-ORIGINATING-IP Received/;
  my @defList2  = qw/From To Date Subject/;
  foreach (@fieldList) { $winFields->lvFieldsSel->InsertItem(-text => $_); }
  # Load each selected default fields
  if (exists($SETTINGS{PHT_SEL})) { # Parse headers
    my @selected = split(/ /, $SETTINGS{PHT_SEL});
    foreach (@selected) { $FIELDS{PHT_SEL}{$_} = 1; $FIELDS{PH_SEL}{$_} = 1; }
  } else { foreach (@defList1) {
    $FIELDS{PHT_SEL}{$_} = 1; $FIELDS{PH_SEL}{$_} = 1; } }
  if (exists($SETTINGS{ET_SEL})) { # Extract
    my @selected = split(/ /, $SETTINGS{ET_SEL});
    foreach (@selected) { $FIELDS{ET_SEL}{$_} = 1; $FIELDS{E_SEL}{$_}  = 1; }
  } else { foreach (@defList2) { $FIELDS{ET_SEL}{$_} = 1; $FIELDS{E_SEL}{$_}  = 1; } }
  # Logging
  if (exists($SETTINGS{'6TO4'})) { $winSettings->ch6to4->Checked($SETTINGS{'6TO4'});        }
  else                           { $winSettings->ch6to4->Checked(1); $SETTINGS{'6TO4'} = 1; } # Default is checked
  # Databases
  if (exists($SETTINGS{XLWHOIS_DB}) and -f $SETTINGS{XLWHOIS_DB}) { $winSettings->tfXLWHOISDB->Text($SETTINGS{XLWHOIS_DB}); }
  elsif (-e "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Whois\\Whois.db") {
    $SETTINGS{XLWHOIS_DB} = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Whois\\Whois.db";
    $winSettings->tfXLWHOISDB->Text($SETTINGS{XLWHOIS_DB});
  }
  $win->chPHISP->Enable() if exists($SETTINGS{XLWHOIS_DB}) and -f $SETTINGS{XLWHOIS_DB};
  if (exists($SETTINGS{GEOIP_DB}) and -f $SETTINGS{GEOIP_DB}) { $winSettings->tfGeoIPDB->Text($SETTINGS{GEOIP_DB}); }
  else {
    my $defaultPath = "$ENV{'PROGRAMDATA'}\\Maxmind\\GeoIPUpdate\\GeoIP\\GeoLite2-City.mmdb";
       $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Tools\\GeoLite2-City.mmdb"  if !-f $defaultPath;
       $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Whois\\GeoLite2-City.mmdb"  if !-f $defaultPath;
       $defaultPath = "$ENV{'APPDATA'}\\XL-Toolkit\\XL-Parser\\GeoLite2-City.mmdb" if !-f $defaultPath;
    if (-f $defaultPath) {
      $SETTINGS{GEOIP_DB} = $defaultPath;
      $winSettings->tfGeoIPDB->Text($SETTINGS{GEOIP_DB});
    }
  }
  $win->chPHGeoIP->Enable() if exists($SETTINGS{GEOIP_DB}) and -f $SETTINGS{GEOIP_DB};
  # Report format for Parse headers
  if (exists($SETTINGS{REPORT_FORMAT})) {
		$win->cbReportFormat->SetCurSel($SETTINGS{REPORT_FORMAT});
    &cbReportFormat_Change();
	} else {
    $SETTINGS{REPORT_FORMAT} = 0; # Default is XLSX
    $win->cbReportFormat->SetCurSel(0);
  }
  # Max width for XLSX
  if (exists($SETTINGS{XLSX_MAX_WIDTH})) { $win->upXLXSMaxWidth->SetPos($SETTINGS{XLSX_MAX_WIDTH}); }
  else {
    $SETTINGS{XLSX_MAX_WIDTH} = 100;
    $win->upXLXSMaxWidth->SetPos($SETTINGS{XLSX_MAX_WIDTH});
  }
  # Default separator for CSV
  if (exists($SETTINGS{CSV_SEPARATOR})) { $win->cbCSVSepar->SetCurSel($SETTINGS{CSV_SEPARATOR}); }
  else {
    $SETTINGS{CSV_SEPARATOR} = 0; # Default is Tab
    $win->cbCSVSepar->SetCurSel($SETTINGS{CSV_SEPARATOR});
  }  
  # Destination directory
  if (exists($SETTINGS{DEST_DIR}) and -d $SETTINGS{DEST_DIR}) { $win->tfDestDir->Text($SETTINGS{DEST_DIR}); }
  else { # Default dir
    mkdir("$USERDIR\\Reports") if !-d "$USERDIR\\Reports";
    if (-d "$USERDIR\\Reports") {    
      $SETTINGS{DEST_DIR} = "$USERDIR\\Reports";
      $win->tfDestDir->Text("$USERDIR\\Reports");
    }
  }
  if (exists($SETTINGS{AUTO_OPEN_REPORT})) { $win->chOpenAtEnd->Checked($SETTINGS{AUTO_OPEN_REPORT});        }
  else                                     { $win->chOpenAtEnd->Checked(1); $SETTINGS{AUTO_OPEN_REPORT} = 1; } # Default is checked
  &saveSettings();
}  #--- End loadSettings
#--------------------------#
sub updateTool {
#--------------------------#
  my $confirm = shift;
  # Download the version file  
  my $ua = new LWP::UserAgent;
  $ua->agent("XL-ParseMails Update $VERSION");
  $ua->default_header('Accept-Language' => 'en');
  my $req = new HTTP::Request GET => $URL_VER;
  my $res = $ua->request($req);
  # Success, compare versions
  if ($res->is_success) {
    my $status  = $res->code;
    my $content = $res->content;
    my $currVer;
    $currVer = $1 if $content =~ /([\d\.]+)/i;
    # No update available
    if ($currVer le $VERSION) {
      Win32::GUI::MessageBox($winSettings, 'You have the latest version installed.', 'Update XL-ParseMails', 0x40040) if $confirm; # Up to date
    } else {
      my $answer = Win32::GUI::MessageBox($winSettings, "Version $currVer is available. Download it?", 'Update XL-ParseMails', 0x40024); # Download available
      # Download the update
      if ($answer == 6) {
        # Open RDP-Parser page with default browser
        $win->ShellExecute('open', $URL_TOOL,'','',1) or
        Win32::GUI::MessageBox($winSettings, Win32::FormatMessage(Win32::GetLastError()), 'Update XL-ParseMails',0x40010);
      }
    }
  }
  # Error 
  else {
    Win32::GUI::MessageBox($winSettings, 'Connection error when checking for update on le-tools.com: '.$res->status_line, 'Update XL-ParseMails',0x40010) if $confirm;
    &logError('Connection error when checking for update on le-tools.com: ' .$res->status_line) if $SETTINGS{LOGGING};
  }
}  #--- End updateTool